<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SOP Designer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--primary:#1d4e2d; --accent:#2f7a4d; --danger:#b00020; --bg:#f9fafb; --border:#e5e7eb}
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif; margin:0; background:var(--bg); color:#1f2937}

.top-bar{background:#fff; border-bottom:1px solid var(--border); padding:12px 20px; display:flex; align-items:center; justify-content:space-between; gap:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.logo-area{font-size:18px; font-weight:600; color:var(--primary); display:flex; align-items:center; gap:8px}
.logo-area img{height:28px; object-fit:contain}

.main-controls{display:flex; gap:8px; align-items:center}
button{background-color:#e8f5e9; color:#1d4e2d; border:none; cursor:pointer; border-radius:8px; padding:8px 14px; font-size:14px; font-weight:500; transition:0.3s}
button:hover{background-color:#1d4e2d; box-shadow:0 0 0 5px #1d4e2d5f; color:#fff}
button.secondary{background:#f3f4f6; color:#6b7280}
button.secondary:hover{background:#6b7280; box-shadow:0 0 0 5px #6b72805f; color:#fff}

.container{display:flex; height:calc(100vh - 60px)}
.editor-panel{flex:1; padding:20px; overflow:auto}
.sidebar{width:280px; background:#fff; border-left:1px solid var(--border); padding:16px; overflow:auto}
.sidebar.hidden{display:none}

#editor{background:#fff; border-radius:8px; min-height:400px; border:1px solid var(--border); padding:16px}

.empty-state{text-align:center; padding:40px 20px; color:#6b7280}
.empty-state h2{color:var(--primary); font-size:20px; margin:0 0 12px 0}
.template-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-top:20px}
.template-card{padding:16px; border:2px solid var(--border); border-radius:8px; cursor:pointer; transition:all 0.2s}
.template-card:hover{border-color:var(--primary); background:#f0f9f4; transform:translateY(-2px)}
.template-card-title{font-weight:600; color:var(--primary); margin:0 0 4px 0; font-size:13px}
.template-card-desc{font-size:12px; color:#6b7280; margin:0}

.sop-step, .sop-task, .sop-subtask{position:relative; margin:8px 0; padding:12px; border-radius:6px; border-left:4px solid var(--primary); background:#fcfffb; border:1px solid var(--border)}
.sop-task{margin-left:16px; border-color:var(--accent)}
.sop-subtask{margin-left:32px; border-color:#4a9f5c}

.step-header{display:flex; align-items:center; gap:8px; margin-bottom:8px}
.step-number{font-weight:700; color:var(--primary); min-width:24px}
.step-title{flex:1; font-size:15px; font-weight:500; color:#1f2937; border:none; padding:0; background:transparent}
.step-time{font-size:12px; color:#6b7280; width:50px; text-align:right}

.step-controls{display:flex; gap:4px; margin-top:8px}
.btn-icon{width:28px; height:28px; padding:0; font-size:13px; display:flex; align-items:center; justify-content:center; border-radius:4px; background:#e8f5e9; color:#1d4e2d; border:none; cursor:pointer}
.btn-icon:hover{background:#1d4e2d; color:#fff}

.step-completed{background:#ecfdf5 !important; opacity:0.7}
.step-completed .step-title{text-decoration:line-through; color:#9ca3af}

.sidebar-section{margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--border)}
.sidebar-section h4{margin:0 0 8px 0; font-size:13px; font-weight:600; color:var(--primary); text-transform:uppercase}

.save-animation{position:fixed; top:20px; right:20px; background:#10b981; color:#fff; padding:10px 14px; border-radius:6px; font-size:13px; animation:fadeInOut 2s ease-in-out; z-index:2000}
@keyframes fadeInOut{0%{opacity:1; transform:translateY(0)} 90%{opacity:1} 100%{opacity:0; transform:translateY(-10px)}}

.toast{position:fixed; right:20px; bottom:20px; background:#1f2937; color:#fff; padding:12px 16px; border-radius:6px; opacity:0.95; z-index:1600; display:none}

.modal{position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; box-shadow:0 20px 60px rgba(0,0,0,0.15); border-radius:8px; z-index:1400; padding:20px; max-width:95%; max-height:80vh; overflow:auto; display:none}
.modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:16px}
.modal-header h3{margin:0; font-size:16px}
.modal-close{background:transparent; color:#6b7280; border:none; font-size:20px; cursor:pointer; padding:0; width:24px; height:24px}

.modal-overlay{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.3); z-index:1399; display:none}

footer{background:#fff; border-top:1px solid var(--border); padding:16px 20px; text-align:center; font-size:12px; color:#6b7280}
footer a{color:var(--primary); text-decoration:none; font-weight:500}

.footer-button{background-color:#e8f5e9; color:#1d4e2d; border:none; cursor:pointer; border-radius:8px; padding:0.7em 1.4em; font-size:13px; font-weight:500; transition:0.3s; text-decoration:none; display:inline-block; margin:6px 4px}
.footer-button:hover{background-color:#1d4e2d; box-shadow:0 0 0 5px #1d4e2d5f; color:#fff}

@media(max-width:768px){
  .sidebar{position:fixed; left:0; top:60px; height:calc(100vh - 60px); z-index:100; border-left:none; border-top:1px solid var(--border); width:100%}
  .sidebar.hidden{display:none}
}
</style>
</head>
<body>

<div class="top-bar">
  <div class="logo-area">
    <img id="logo-preview" alt="" />
    <span>SOP Designer</span>
  </div>
  
  <div class="main-controls">
    <button id="new-btn" onclick="showNewMenu()">+ New SOP</button>
    <button id="pdf-btn" onclick="exportPDF()" style="display:none">Export PDF</button>
    <button id="export-btn" onclick="showExportMenu()" style="display:none">More</button>
    <button id="share-btn" onclick="generateShareLink()" style="display:none" class="secondary">Share</button>
    <button onclick="toggleSidebar()" class="secondary">Menu</button>
  </div>
</div>

<div class="container">
  <div class="editor-panel">
    <div id="editor"></div>
  </div>
  
  <div class="sidebar hidden">
    <div class="sidebar-section">
      <h4>Options</h4>
      <button onclick="showUploadSOP()" style="width:100%; margin-bottom:8px">Open File</button>
      <button onclick="downloadSOPFile()" style="width:100%; margin-bottom:8px">Save File</button>
      <button onclick="undo()" style="width:100%; margin-bottom:8px" class="secondary">Undo</button>
      <button onclick="redo()" style="width:100%; margin-bottom:8px" class="secondary">Redo</button>
    </div>
    
    <div class="sidebar-section">
      <h4>Info</h4>
      <div style="font-size:12px; color:#6b7280">
        <div>Total time: <strong id="total-time">0</strong> min</div>
        <div style="margin-top:4px">Steps: <strong id="step-count">0</strong></div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeAllModals()"></div>

<div class="modal" id="newSOPModal">
  <div class="modal-header">
    <h3>Create New SOP</h3>
    <button class="modal-close" onclick="closeAllModals()">×</button>
  </div>
  <div class="template-grid" id="templateGrid"></div>
  <button onclick="closeAllModals(); startBlankSOP()" style="width:100%; margin-top:16px">Start Blank</button>
</div>

<div class="modal" id="exportModal">
  <div class="modal-header">
    <h3>Export SOP</h3>
    <button class="modal-close" onclick="closeAllModals()">×</button>
  </div>
  <div style="display:flex; flex-direction:column; gap:8px">
    <button onclick="exportPDF()">Export as PDF</button>
    <button onclick="exportMarkdown()">Export as Markdown</button>
    <button onclick="downloadSOPFile()">Save as File</button>
  </div>
</div>

<div id="toast" class="toast"></div>
<input id="upload-sop-file" type="file" accept=".json,.sop" style="display:none" />

<footer>
  <p style="margin:0">DGS Consulting<br>
  <a href="https://dgsconsulting.solutions/" target="_blank" class="footer-button">Visit Website</a> 
  <a href="https://www.linkedin.com/in/dg-snook/" target="_blank" class="footer-button">LinkedIn</a> 
  <a href="mailto:DGSConsult@consultant.com" class="footer-button">Contact</a></p>
</footer>

<script>
const STORAGE_KEY = 'sop_designer_v1';
let logoDataURL = '';
let runMode = false;
const MAX_HISTORY = 100;
let historyStack = [], historyIndex = -1;
let saveTimer = null;
let dragSrc = null;

const editor = document.getElementById('editor');
const { jsPDF } = window.jspdf;

function showToast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(()=> el.style.display='none', 2000);
}

function closeAllModals(){
  document.querySelectorAll('.modal').forEach(m => m.style.display='none');
  document.getElementById('modalOverlay').style.display = 'none';
}

function showModal(id){
  document.getElementById('modalOverlay').style.display = 'block';
  document.getElementById(id).style.display = 'block';
}

function toggleSidebar(){
  document.querySelector('.sidebar').classList.toggle('hidden');
}

function createNode(type, placeholder=''){
  const el = document.createElement('div');
  el.className = type;
  el.draggable = true;
  
  el.innerHTML = `
    <div class="step-header">
      <span class="step-number"></span>
      <input type="text" class="step-title" placeholder="${placeholder}" />
      <input type="number" class="step-time" min="0" placeholder="0" />
    </div>
    <div class="step-controls">
      <button class="btn-icon" onclick="addSubStep(this.closest('div'))">+</button>
      <button class="btn-icon" onclick="deleteStep(this.closest('div'))">✖</button>
    </div>
    <div class="children" style="margin-top:8px"></div>
    <div class="note" contenteditable="true" placeholder="Notes..." style="font-size:13px; color:#6b7280; margin-top:8px; padding:8px; border-radius:4px; background:#f9fafb; min-height:24px"></div>
  `;
  
  el.querySelector('.step-title').addEventListener('input', ()=>{ renumber(); saveSOPDebounced(); });
  el.querySelector('.step-time').addEventListener('input', ()=>{ calcTotalTime(); saveSOPDebounced(); });
  el.querySelector('.note').addEventListener('input', ()=> saveSOPDebounced());
  
  enableDrag(el);
  return el;
}

function addSubStep(parentEl){
  const currentType = parentEl.className;
  const newType = currentType === 'sop-step' ? 'sop-task' : currentType === 'sop-task' ? 'sop-subtask' : 'sop-step';
  const child = createNode(newType, 'New item');
  parentEl.querySelector('.children').appendChild(child);
  renumber();
  calcTotalTime();
  updateStepCount();
  saveSOPDebounced();
}

function deleteStep(el){
  el.remove();
  renumber();
  calcTotalTime();
  updateStepCount();
  saveSOPDebounced();
}

function enableDrag(el){
  el.addEventListener('dragstart', e => {
    dragSrc = el;
    el.style.opacity = '0.5';
  });
  
  el.addEventListener('dragend', () => {
    if(dragSrc) dragSrc.style.opacity = '1';
    dragSrc = null;
  });

  el.addEventListener('dragover', e => e.preventDefault());
  el.addEventListener('drop', e => {
    e.preventDefault();
    if(!dragSrc || dragSrc === el) return;
    el.parentNode.insertBefore(dragSrc, el);
    renumber();
    saveSOPDebounced();
  });
}

function renumber(){
  const steps = Array.from(editor.querySelectorAll(':scope > .sop-step'));
  steps.forEach((step, si) => {
    step.querySelector('.step-number').textContent = si+1;
    const tasks = Array.from(step.querySelectorAll(':scope > .children > .sop-task'));
    tasks.forEach((task, ti) => {
      task.querySelector('.step-number').textContent = `${si+1}.${ti+1}`;
      const subs = Array.from(task.querySelectorAll(':scope > .children > .sop-subtask'));
      subs.forEach((sub, ui) => sub.querySelector('.step-number').textContent = `${si+1}.${ti+1}.${ui+1}`);
    });
  });
}

function calcTotalTime(){
  let total = 0;
  editor.querySelectorAll('.step-time').forEach(inp => {
    const v = parseInt(inp.value) || 0;
    total += v;
  });
  document.getElementById('total-time').textContent = total;
}

function updateStepCount(){
  const count = editor.querySelectorAll(':scope > .sop-step').length;
  document.getElementById('step-count').textContent = count;
}

function saveSOP(){
  const data = { html: editor.innerHTML, logo: logoDataURL };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  
  const anim = document.createElement('div');
  anim.className = 'save-animation';
  anim.textContent = '✓ Saved';
  document.body.appendChild(anim);
  setTimeout(() => anim.remove(), 2000);
}

function saveSOPDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => saveSOP(), 600);
}

function loadSOP(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return showEmptyState();
  try {
    const data = JSON.parse(raw);
    editor.innerHTML = data.html;
    if(data.logo) logoDataURL = data.logo;
    showEditorUI();
    renumber();
    calcTotalTime();
    updateStepCount();
  } catch(e){ showEmptyState(); }
}

function showEmptyState(){
  editor.innerHTML = `
    <div class="empty-state">
      <h2>Welcome to SOP Designer</h2>
      <p>Create Standard Operating Procedures for your business</p>
      <div style="background:#f0f9f4; border:2px solid #1d4e2d; border-radius:8px; padding:16px; margin:16px 0; color:#1f2937">
        <div style="font-weight:600; margin-bottom:8px">Getting Started:</div>
        <div style="font-size:13px; line-height:1.6">
          1. Choose a template or start blank<br>
          2. Click + Add Step to build<br>
          3. Export as PDF or share
        </div>
      </div>
      <div class="template-grid" id="emptyTemplateGrid"></div>
      <button onclick="showNewMenu()" style="margin-top:20px">Get Started</button>
    </div>
  `;
  renderEmptyTemplates();
  document.getElementById('pdf-btn').style.display = 'none';
  document.getElementById('export-btn').style.display = 'none';
  document.getElementById('share-btn').style.display = 'none';
}

function showEditorUI(){
  document.getElementById('pdf-btn').style.display = 'block';
  document.getElementById('export-btn').style.display = 'block';
  document.getElementById('share-btn').style.display = 'block';
  document.getElementById('new-btn').textContent = '+ Add Step';
  document.getElementById('new-btn').onclick = addStep;
}

function renderEmptyTemplates(){
  const grid = document.getElementById('emptyTemplateGrid');
  if(!grid) return;
  grid.innerHTML = '';
  [
    {id:'ops', name:'Operations', desc:'Prepare, execute, verify'},
    {id:'onboard', name:'Onboarding', desc:'Setup & introduction'},
    {id:'booking', name:'Appointment', desc:'Request & confirm'}
  ].forEach(t => {
    const card = document.createElement('div');
    card.className = 'template-card';
    card.innerHTML = `<div class="template-card-title">${t.name}</div><div class="template-card-desc">${t.desc}</div>`;
    card.onclick = () => loadTemplate(t.id);
    grid.appendChild(card);
  });
}

function loadTemplate(id){
  const templates = {
    ops: () => {
      const d = document.createElement('div');
      d.appendChild(createNodeFromJson('Prepare', 5));
      d.appendChild(createNodeFromJson('Execute', 20));
      d.appendChild(createNodeFromJson('Verify', 5));
      return d.innerHTML;
    },
    onboard: () => {
      const d = document.createElement('div');
      d.appendChild(createNodeFromJson('Collect info', 10));
      d.appendChild(createNodeFromJson('Schedule call', 15));
      d.appendChild(createNodeFromJson('Setup access', 20));
      return d.innerHTML;
    },
    booking: () => {
      const d = document.createElement('div');
      d.appendChild(createNodeFromJson('Receive request', 5));
      d.appendChild(createNodeFromJson('Confirm time', 3));
      d.appendChild(createNodeFromJson('Send reminder', 1));
      return d.innerHTML;
    }
  };
  
  if(!templates[id]) return;
  editor.innerHTML = templates[id]();
  showEditorUI();
  renumber();
  calcTotalTime();
  updateStepCount();
  pushHistory();
  showToast('Template loaded');
  closeAllModals();
}

function createNodeFromJson(title, time){
  const node = createNode('sop-step', '');
  node.querySelector('.step-title').value = title;
  node.querySelector('.step-time').value = time;
  return node;
}

function addStep(){
  if(editor.innerHTML.includes('empty-state')) showEditorUI();
  const step = createNode('sop-step', 'New step');
  editor.appendChild(step);
  renumber();
  calcTotalTime();
  updateStepCount();
  saveSOPDebounced();
  pushHistory();
  step.querySelector('.step-title').focus();
}

function exportPDF(){
  const pdf = new jsPDF({unit:'pt', format:'a4'});
  const margin = 40, pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
  let y = margin, total = 0;

  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(16);
  pdf.text('SOP', margin, y);
  y += 40;

  function traverse(node, depth=0){
    Array.from(node.children).forEach(child => {
      if(child.classList.contains('sop-step') || child.classList.contains('sop-task') || child.classList.contains('sop-subtask')){
        const num = child.querySelector('.step-number').textContent || '';
        const title = child.querySelector('.step-title').value || '';
        const time = child.querySelector('.step-time').value;
        const indent = margin + depth * 20;
        pdf.setFont('helvetica', 'normal');
        pdf.text(`${num} ${title}${time ? ` (${time}m)` : ''}`, indent, y);
        if(time) total += parseInt(time) || 0;
        y += 16;
        traverse(child.querySelector('.children'), depth+1);
      }
    });
  }

  traverse(editor, 0);
  y += 8;
  pdf.text(`Total: ${total} min`, margin, y);

  pdf.save('SOP.pdf');
  showToast('PDF exported');
}

function exportMarkdown(){
  let md = `# SOP\n_${new Date().toLocaleString()}_\n\n`;
  let total = 0;

  function walk(node, depth=0){
    Array.from(node.children).forEach(child => {
      if(child.classList.contains('sop-step') || child.classList.contains('sop-task') || child.classList.contains('sop-subtask')){
        const indent = '  '.repeat(depth);
        const num = child.querySelector('.step-number').textContent || '';
        const title = child.querySelector('.step-title').value || '';
        const time = child.querySelector('.step-time').value;
        md += `${indent}- **${num} ${title}**${time ? ` (${time}m)` : ''}\n`;
        if(time) total += parseInt(time) || 0;
        walk(child.querySelector('.children'), depth+1);
      }
    });
  }

  walk(editor, 0);
  md += `\n**Total: ${total} minutes**\n`;
  const blob = new Blob([md], {type:'text/markdown'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'SOP.md';
  a.click();
}

function showExportMenu(){
  showModal('exportModal');
}

function downloadSOPFile(){
  const data = {html: editor.innerHTML, logo: logoDataURL};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'SOP.json';
  a.click();
}

function showUploadSOP(){
  document.getElementById('upload-sop-file').click();
}

function showNewMenu(){
  const grid = document.getElementById('templateGrid');
  grid.innerHTML = '';
  [
    {id:'ops', name:'Operations', desc:'Prepare, execute, verify'},
    {id:'onboard', name:'Onboarding', desc:'Setup & introduction'},
    {id:'booking', name:'Appointment', desc:'Request & confirm'}
  ].forEach(t => {
    const card = document.createElement('div');
    card.className = 'template-card';
    card.innerHTML = `<div class="template-card-title">${t.name}</div><div class="template-card-desc">${t.desc}</div>`;
    card.onclick = () => loadTemplate(t.id);
    grid.appendChild(card);
  });
  showModal('newSOPModal');
}

function startBlankSOP(){
  editor.innerHTML = '';
  showEditorUI();
  pushHistory();
}

function pushHistory(){
  const snapshot = JSON.stringify({html: editor.innerHTML, logo: logoDataURL});
  if(historyIndex < historyStack.length - 1) historyStack = historyStack.slice(0, historyIndex + 1);
  historyStack.push(snapshot);
  historyIndex = historyStack.length - 1;
  if(historyStack.length > MAX_HISTORY) historyStack.shift();
}

function undo(){
  if(historyIndex <= 0) return showToast('Nothing to undo');
  historyIndex--;
  const snap = JSON.parse(historyStack[historyIndex]);
  editor.innerHTML = snap.html;
  renumber();
  calcTotalTime();
  updateStepCount();
  showToast('Undo');
}

function redo(){
  if(historyIndex >= historyStack.length - 1) return showToast('Nothing to redo');
  historyIndex++;
  const snap = JSON.parse(historyStack[historyIndex]);
  editor.innerHTML = snap.html;
  renumber();
  calcTotalTime();
  updateStepCount();
  showToast('Redo');
}

function generateShareLink(){
  const data = {html: editor.innerHTML, logo: logoDataURL};
  const encoded = btoa(JSON.stringify(data));
  const url = `${window.location.origin}${window.location.pathname}?sop=${encoded}`;
  navigator.clipboard.writeText(url).then(() => showToast('Link copied!')).catch(() => showToast('Copy failed'));
}

document.getElementById('upload-sop-file').addEventListener('change', e => {
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const d = JSON.parse(ev.target.result);
      editor.innerHTML = d.html;
      if(d.logo) logoDataURL = d.logo;
      showEditorUI();
      renumber();
      calcTotalTime();
      updateStepCount();
      showToast('SOP loaded');
    } catch(err){ alert('Invalid file'); }
  };
  reader.readAsText(f);
});

loadSOP();
pushHistory();
</script>
</body>
</html>
