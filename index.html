<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SOP Designer | Numbered Export</title>
<style>
:root {
  --primary:#1d4e2d; --accent:#2f7a4d; --danger:#a00;
  --bg:#f5f5f5; --text:#222; --border:#ddd;
}
*{box-sizing:border-box;}
body{font-family:"Segoe UI",Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0;}
header{background:var(--primary);color:#fff;padding:1.5rem;text-align:center;}
header h1{margin:0 0 .5rem;font-size:2rem;}
main{max-width:1100px;margin:0 auto;padding:2rem;}
button{background:var(--primary);color:#fff;padding:.5rem 1rem;border:none;border-radius:6px;cursor:pointer;margin:.25rem;font-size:.9rem;}
button:hover{background:var(--accent);}
#editor{background:#fff;padding:1.5rem;border-radius:8px;min-height:300px;border:1px solid var(--border);}
.sop-step,.sop-task,.sop-subtask,.sop-checklist{border-left:4px solid var(--primary);margin:1rem 0;padding:1rem;border-radius:6px;background:#fdfdfd;cursor:move;}
.sop-task{border-color:#2f7a4d;margin-left:20px;}
.sop-subtask{border-color:#4a9f5c;margin-left:40px;}
.sop-checklist{margin-left:60px;}
.sop-step.dragging,.sop-task.dragging,.sop-subtask.dragging,.sop-checklist.dragging{opacity:.5;}
.add-item-btn,.remove-item-btn,.add-task-btn,.add-subtask-btn,.add-checklist-btn{
  background:var(--accent);color:#fff;border:none;border-radius:4px;font-size:0.8rem;padding:.25rem .5rem;cursor:pointer;margin-left:.5rem;
}
.add-item-btn:hover,.remove-item-btn:hover{background:#166a36;}
</style>
</head>
<body>
<header><h1>SOP Designer</h1></header>
<main>
<section>
  <button id="insert-step-btn">‚ûï Add Step</button>
  <button id="save-sop-btn">üíæ Save</button>
  <button id="export-sop-btn">üì§ Export</button>
  <button id="clear-sop-btn" style="background:var(--danger)">üóëÔ∏è Clear</button>
</section>
<div id="editor"></div>
</main>

<script>
const editor=document.getElementById('editor');
const STORAGE_KEY='sop-designer-numbered-v1';

function save(){localStorage.setItem(STORAGE_KEY,editor.innerHTML);}
function load(){const content=localStorage.getItem(STORAGE_KEY);if(content)editor.innerHTML=content;}
function clearAll(){editor.innerHTML='';localStorage.removeItem(STORAGE_KEY);}
window.addEventListener('load',()=>{load();makeDraggable();});

// Insert Elements
function insertStep(){insertHTML('<div class="sop-step" draggable="true"><strong>Step:</strong> Describe step <button class="add-task-btn">+ Task</button></div>');makeDraggable();}
function insertTask(parent){insertHTML('<div class="sop-task" draggable="true"><strong>Task:</strong> Describe task <button class="add-subtask-btn">+ Sub-task</button></div>',parent);makeDraggable();}
function insertSubTask(parent){insertHTML('<div class="sop-subtask" draggable="true"><strong>Sub-task:</strong> Describe sub-task <button class="add-checklist-btn">+ Checklist</button></div>',parent);makeDraggable();}
function insertChecklist(parent){
  const html=`
  <div class="sop-checklist" draggable="true">
    <div><input type="checkbox"> Checklist item <button class="remove-item-btn">Remove</button></div>
    <button class="add-item-btn">+ Item</button>
  </div>`;
  insertHTML(html,parent);makeDraggable();
}
function insertHTML(html,parent=editor){const frag=document.createRange().createContextualFragment(html);parent.appendChild(frag);save();}

// Button actions
document.getElementById('insert-step-btn').addEventListener('click',insertStep);
document.getElementById('save-sop-btn').addEventListener('click',save);
document.getElementById('export-sop-btn').addEventListener('click',exportPDF);
document.getElementById('clear-sop-btn').addEventListener('click',clearAll);
editor.addEventListener('click',e=>{
  if(e.target.classList.contains('add-task-btn'))insertTask(e.target.parentElement);
  if(e.target.classList.contains('add-subtask-btn'))insertSubTask(e.target.parentElement);
  if(e.target.classList.contains('add-checklist-btn'))insertChecklist(e.target.parentElement);
  if(e.target.classList.contains('add-item-btn')){
    const div=document.createElement('div');
    div.innerHTML='<input type="checkbox"> New item <button class="remove-item-btn">Remove</button>';
    e.target.parentElement.insertBefore(div,e.target);
  }
  if(e.target.classList.contains('remove-item-btn'))e.target.parentElement.remove();
  save();
});

// Drag & drop
let dragSrc=null;
function handleDragStart(e){dragSrc=this;this.classList.add('dragging');e.dataTransfer.effectAllowed='move';}
function handleDragOver(e){e.preventDefault();return false;}
function handleDrop(e){e.stopPropagation();if(dragSrc!=this){editor.insertBefore(dragSrc,this);}return false;}
function handleDragEnd(){this.classList.remove('dragging');}
function makeDraggable(){
  const items=editor.querySelectorAll('.sop-step,.sop-task,.sop-subtask,.sop-checklist');
  items.forEach(it=>{
    it.setAttribute('draggable','true');
    it.removeEventListener('dragstart',handleDragStart);
    it.addEventListener('dragstart',handleDragStart);
    it.addEventListener('dragover',handleDragOver);
    it.addEventListener('drop',handleDrop);
    it.addEventListener('dragend',handleDragEnd);
  });
}
editor.addEventListener('input',makeDraggable);

// Numbering logic
function generateNumbering(){
  const steps=[...editor.querySelectorAll('.sop-step')];
  steps.forEach((step,i)=>{
    step.querySelector('strong').textContent=`Step ${i+1}:`;
    const tasks=[...step.querySelectorAll(':scope > .sop-task')];
    tasks.forEach((task,j)=>{
      task.querySelector('strong').textContent=`${i+1}.${j+1} Task:`;
      const subs=[...task.querySelectorAll(':scope > .sop-subtask')];
      subs.forEach((sub,k)=>{
        sub.querySelector('strong').textContent=`${i+1}.${j+1}.${k+1} Sub-task:`;
      });
    });
  });
}

// Export PDF
function exportPDF(){
  generateNumbering();
  const win=window.open('','', 'width=900,height=700');
  const styles=`
    body{font-family:Arial,sans-serif;padding:2rem;color:#222;}
    .sop-step{border-left:4px solid #1d4e2d;margin:1rem 0;padding:1rem;}
    .sop-task{margin-left:20px;border-left:4px solid #2f7a4d;padding:1rem;}
    .sop-subtask{margin-left:40px;border-left:4px solid #4a9f5c;padding:1rem;}
    .sop-checklist{margin-left:60px;padding:0.5rem;}
    input[type="checkbox"]{transform:scale(1.2);margin-right:0.5rem;}
    button{display:none;}
  `;
  win.document.write(`<html><head><title>SOP Export</title><style>${styles}</style></head><body>`);
  win.document.write('<h1>Standard Operating Procedure</h1>');
  win.document.write(editor.innerHTML);
  win.document.write('</body></html>');
  win.document.close();
  win.focus();
  win.print();
}
</script>
</body>
</html>
