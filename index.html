<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SOP Designer ‚Äì MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:1rem; }
    h1 { margin-bottom:1rem; }
    #controls { margin-bottom:1rem; display:flex; flex-wrap:wrap; gap:.5rem; }
    button { padding:0.5rem 1rem; border:none; background:#007b55; color:white; border-radius:6px; cursor:pointer; }
    button:hover { background:#005e40; }
    #editor { background:white; padding:1rem; border-radius:8px; min-height:300px; }
    .sop-step, .sop-task, .sop-subtask, .sop-checklist {
      margin:.4rem 0; padding:.5rem; border:1px solid #ccc; border-radius:6px;
      background:#fafafa; cursor:grab;
    }
    .sop-step { background:#e8f5e9; }
    .sop-task { background:#f0f0f0; margin-left:20px; }
    .sop-subtask { background:#f9f9f9; margin-left:40px; }
    .sop-checklist { background:#fff; margin-left:60px; display:flex; align-items:center; gap:0.5rem; }
    .note { display:block; font-style:italic; color:#444; margin-top:0.3rem; }
    .time-input { width:60px; margin-left:8px; }
    .add-item-btn, .remove-item-btn { margin-left:0.5rem; background:#666; }
    .remove-item-btn { background:#c62828; }
    .drag-over { border:2px dashed #007b55; }
    #logo-preview { max-height:40px; margin-left:1rem; vertical-align:middle; }
  </style>
</head>
<body>
  <h1>SOP Designer MVP üõ†Ô∏è <img id="logo-preview" /></h1>

  <div id="controls">
    <button onclick="addStep()">+ Add Step</button>
    <button onclick="exportPDF()">üìÑ Export PDF</button>
    <button onclick="exportMarkdown()">üìù Export Markdown</button>
    <label style="display:flex;align-items:center;gap:.5rem;">
      üñºÔ∏è Upload Logo
      <input type="file" id="logo-upload" accept="image/*" />
    </label>
  </div>

  <div id="editor"></div>

  <script>
    let logoDataURL = "";

    // === Add Elements ===
    function addStep() {
      const step = createElement('sop-step', 'Step');
      editor.appendChild(step);
    }

    function addTask(parent) {
      const task = createElement('sop-task', 'Task');
      parent.appendChild(task);
    }

    function addSubtask(parent) {
      const sub = createElement('sop-subtask', 'Subtask');
      parent.appendChild(sub);
    }

    function addChecklist(parent) {
      const check = document.createElement('div');
      check.className = 'sop-checklist';
      check.draggable = true;
      check.innerHTML = `
        <input type="checkbox" />
        <input type="text" placeholder="Checklist item..." />
        <button class="remove-item-btn" onclick="this.parentNode.remove()">‚úñ</button>`;
      enableDrag(check);
      parent.appendChild(check);
    }

    function createElement(type, placeholder) {
      const div = document.createElement('div');
      div.className = type;
      div.draggable = true;
      div.innerHTML = `
        <span class="number-label"></span>
        <input type="text" placeholder="${placeholder}..." />
        <input type="number" class="time-input" placeholder="min" />
        <button class="add-item-btn" onclick="addTask(this.parentNode)">+ Task</button>
        <button class="add-item-btn" onclick="addSubtask(this.parentNode)">+ Subtask</button>
        <button class="add-item-btn" onclick="addChecklist(this.parentNode)">+ Checklist</button>
        <button class="remove-item-btn" onclick="this.parentNode.remove()">‚úñ</button>
        <span class="note" contenteditable="true" placeholder="Add note..."></span>`;
      enableDrag(div);
      return div;
    }

    // === Drag & Drop ===
    let dragged;
    function enableDrag(el) {
      el.addEventListener('dragstart', e => dragged = el);
      el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drag-over'); });
      el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
      el.addEventListener('drop', e => {
        e.preventDefault();
        el.classList.remove('drag-over');
        if (dragged && dragged !== el) el.parentNode.insertBefore(dragged, el);
      });
    }

    // === Logo Upload ===
    document.getElementById('logo-upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          logoDataURL = ev.target.result;
          document.getElementById('logo-preview').src = logoDataURL;
        };
        reader.readAsDataURL(file);
      }
    });

    // === PDF Export ===
    const { jsPDF } = window.jspdf;
    async function exportPDF() {
      const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
      const margin = 40;
      let y = margin;
      const lineHeight = 18;
      const pageHeight = pdf.internal.pageSize.getHeight();

      if (logoDataURL) {
        pdf.addImage(logoDataURL, 'PNG', margin, y - 20, 60, 40);
      }

      const titleX = logoDataURL ? margin + 80 : margin;
      pdf.setFont('helvetica', 'bold'); pdf.setFontSize(16);
      pdf.text('SOP Export', titleX, y);
      pdf.setFont('helvetica', 'normal'); pdf.setFontSize(10);
      pdf.text(new Date().toLocaleString(), titleX, y + 15);

      y += logoDataURL ? 50 : 40;

      let totalMinutes = 0;
      function addTextWrapped(text, x, maxWidth) {
        const lines = pdf.splitTextToSize(text, maxWidth);
        lines.forEach(line => {
          if (y > pageHeight - margin) { pdf.addPage(); y = margin; }
          pdf.text(line, x, y);
          y += lineHeight;
        });
      }

      function traverse(node, depth = 0) {
        [...node.children].forEach(child => {
          if (child.classList.contains('sop-step') || child.classList.contains('sop-task') || child.classList.contains('sop-subtask')) {
            const text = child.querySelector('input[type="text"]').value;
            const time = child.querySelector('.time-input').value;
            const note = child.querySelector('.note').textContent.trim();
            const indent = margin + depth * 20;
            addTextWrapped(`${text}${time ? ` (${time} min)` : ''}`, indent, 500 - indent);
            if (time) totalMinutes += parseInt(time);
            if (note) { pdf.setFont('helvetica', 'italic'); addTextWrapped(`Note: ${note}`, indent+15, 480 - indent); pdf.setFont('helvetica','normal'); }
            traverse(child, depth + 1);
          }
          if (child.classList.contains('sop-checklist')) {
            const checked = child.querySelector('input[type="checkbox"]').checked;
            const text = child.querySelector('input[type="text"]').value;
            addTextWrapped(`${checked ? '[x]' : '[ ]'} ${text}`, margin + depth * 20 + 15, 480);
          }
        });
      }

      traverse(editor);
      y += 10;
      pdf.setFont('helvetica', 'bold');
      addTextWrapped(`Total Estimated Time: ${totalMinutes} min`, margin, 500);

      const pageCount = pdf.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        pdf.setPage(i);
        pdf.setFontSize(9);
        pdf.text(`Page ${i} of ${pageCount}`, pdf.internal.pageSize.getWidth() - margin - 60, pageHeight - 20);
      }

      pdf.save('SOP_Export.pdf');
    }

    // === Markdown Export ===
    function exportMarkdown() {
      let md = `# SOP Export\n_${new Date().toLocaleString()}_\n\n`;
      let totalMinutes = 0;

      function traverseMD(node, depth = 0) {
        [...node.children].forEach(child => {
          const indent = '  '.repeat(depth);
          if (child.classList.contains('sop-step') || child.classList.contains('sop-task') || child.classList.contains('sop-subtask')) {
            const text = child.querySelector('input[type="text"]').value;
            const time = child.querySelector('.time-input').value;
            const note = child.querySelector('.note').textContent.trim();
            md += `${indent}- ${text}${time ? ` (${time} min)` : ''}\n`;
            if (note) md += `${indent}  _Note: ${note}_\n`;
            if (time) totalMinutes += parseInt(time);
            traverseMD(child, depth + 1);
          }
          if (child.classList.contains('sop-checklist')) {
            const checked = child.querySelector('input[type="checkbox"]').checked;
            const text = child.querySelector('input[type="text"]').value;
            md += `${indent}- [${checked ? 'x' : ' '}] ${text}\n`;
          }
        });
      }
      traverseMD(editor);
      md += `\n**Total Estimated Time:** ${totalMinutes} min\n`;

      const blob = new Blob([md], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'SOP_Export.md';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
