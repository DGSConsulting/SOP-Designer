<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Professional SOP Designer | DGS Consulting</title>
<meta name="description" content="Create professional Standard Operating Procedures in minutes. Free tool with 50+ templates. Trusted by 500+ businesses.">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* --- CORRECTED AND COMPLETE COLOR VARIABLE SETUP --- */
:root {
Â  /* Brand & Utility Colors */
Â  --primary: #1E293B; Â  Â  /* Dark Blue/Primary Text */
Â  --accent: #06B6D4; Â  Â  Â /* Cyan/Primary CTA */
Â  --success: #10B981; Â  Â  /* Green */
Â  --danger: #EF4444; Â  Â  Â /* Red */

Â  /* Background & Border Colors */
Â  --light: #F9FAFB; Â  Â  Â  /* Lightest background */
Â  --lighter: #FFFFFF; Â  Â  /* Pure white */
Â  --border: #E5E7EB; Â  Â  Â /* Light gray for borders */
Â  --bg: #F3F4F6; Â  Â  Â  Â  Â /* Light gray for secondary button background */
Â  --dark: #1e1e1e; Â  Â  Â  Â /* For general dark elements */
Â  --white: #ffffff;

Â  /* Text Colors */
Â  --text: var(--primary); Â  Â  Â  Â  /* Default text color (set to primary dark blue) */
Â  --text-light: #6B7280; Â  Â  Â  /* Lighter gray for secondary text/labels */
}
/* ------------------------------------------------ */

*{box-sizing:border-box; margin:0; padding:0}
body{
Â  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;Â 
Â  background: linear-gradient(rgba(249, 250, 251, 0.95), rgba(249, 250, 251, 0.95)),
Â  Â  repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(99, 102, 241, 0.02) 10px, rgba(99, 102, 241, 0.02) 20px);
Â  color:var(--text);
Â  overflow-x:hidden;
}

.trust-bar{background:linear-gradient(90deg, var(--success) 0%, #059669 100%); color:#fff; padding:10px 20px; text-align:center; font-size:13px; font-weight:500; box-shadow:0 2px 8px rgba(16,185,129,0.2)}
.trust-bar span{margin:0 20px; display:inline-block}

.top-bar{background:#fff; border-bottom:2px solid var(--border); padding:14px 20px; display:flex; align-items:center; justify-content:space-between; gap:16px; box-shadow:0 2px 12px rgba(0,0,0,0.08); position:sticky; top:0; z-index:100}
.logo-area{font-size:20px; font-weight:700; color:var(--primary); display:flex; align-items:center; gap:10px}
.logo-area img{height:32px; object-fit:contain}
.logo-badge{background:var(--success); color:#fff; font-size:10px; padding:3px 8px; border-radius:12px; font-weight:600; margin-left:8px}

.main-controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
button{
Â  background:var(--accent);Â 
Â  color:#fff;Â 
Â  border:none;Â 
Â  cursor:pointer;Â 
Â  border-radius:8px;Â 
Â  padding:10px 18px;Â 
Â  font-size:14px;Â 
Â  font-weight:600;Â 
Â  transition:all 0.3s ease;
Â  box-shadow:0 2px 8px rgba(6,182,212,0.25);
}
button:hover{
Â  background:#0891b2;Â 
Â  transform:translateY(-2px);
Â  box-shadow:0 4px 16px rgba(6,182,212,0.4);
}
button:disabled{opacity:0.5; cursor:not-allowed; transform:none}
button.secondary{background:#f3f4f6; color:var(--text-light); box-shadow:0 2px 6px rgba(0,0,0,0.1)}
button.secondary:hover{background:var(--text-light); color:#fff}
button.cta-primary{
Â  background:linear-gradient(135deg, var(--success) 0%, #059669 100%);
Â  font-size:15px;
Â  padding:12px 24px;
Â  box-shadow:0 4px 14px rgba(16,185,129,0.4);
}
button.danger{background:var(--danger); box-shadow:0 2px 8px rgba(239,68,68,0.25)}
button.danger:hover{background:#dc2626}

.container{display:flex; min-height:calc(100vh - 200px); margin-top:20px}
.editor-panel{flex:1; padding:20px; overflow:auto; max-width:1200px; margin:0 auto; width:100%}
.sidebar{width:340px; background:#fff; border-left:2px solid var(--border); padding:20px; overflow:auto; box-shadow:-2px 0 12px rgba(0,0,0,0.05)}
.sidebar.hidden{display:none}

.sop-header{background:#fff; border-radius:12px; padding:20px; margin-bottom:20px; border:2px solid var(--border); box-shadow:0 4px 20px rgba(0,0,0,0.08)}
.sop-title{font-size:24px; font-weight:700; color:var(--primary); border:none; width:100%; padding:8px; background:transparent; margin-bottom:12px; border-radius:6px}
.sop-title:focus{background:#f9fafb; outline:2px solid var(--accent)}
.sop-meta{display:flex; gap:16px; flex-wrap:wrap; align-items:center}
.meta-item{display:flex; align-items:center; gap:8px; font-size:14px; color:var(--text-light)}
.meta-item select{padding:6px 10px; border:1px solid var(--border); border-radius:6px; background:#fff; color:var(--text); font-size:14px}

#editor{background:#fff; border-radius:12px; min-height:400px; border:2px solid var(--border); padding:24px; box-shadow:0 4px 20px rgba(0,0,0,0.08)}

.empty-state{text-align:center; padding:60px 20px; color:var(--text-light); max-width:800px; margin:0 auto}
.empty-state h2{color:var(--primary); font-size:32px; margin:0 0 16px 0; font-weight:700}
.empty-state p{font-size:18px; margin-bottom:24px; color:var(--text)}

.template-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-top:24px}
.template-card{
Â  padding:20px;Â 
Â  border:2px solid var(--border);Â 
Â  border-radius:12px;Â 
Â  cursor:pointer;Â 
Â  transition:all 0.3s ease;
Â  background:#fff;
Â  position:relative;
}
.template-card:hover{
Â  border-color:var(--accent);Â 
Â  background:linear-gradient(135deg, #f0f9ff 0%, #cffafe 100%);
Â  transform:translateY(-4px);
Â  box-shadow:0 8px 24px rgba(6,182,212,0.2);
}
.template-card.custom-template{border-color:var(--success)}
.template-card-icon{font-size:32px; margin-bottom:12px}
.template-card-title{font-weight:700; color:var(--primary); margin:0 0 8px 0; font-size:16px}
.template-card-desc{font-size:13px; color:var(--text-light); margin:0 0 8px 0; line-height:1.5}
.template-card-steps{font-size:12px; color:var(--accent); font-weight:600}
.template-delete{position:absolute; top:8px; right:8px; background:var(--danger); color:#fff; border:none; width:24px; height:24px; border-radius:50%; font-size:12px; cursor:pointer; opacity:0; transition:opacity 0.2s}
.template-card:hover .template-delete{opacity:1}

.sop-step{
Â  position:relative;Â 
Â  margin:12px 0;Â 
Â  padding:16px;Â 
Â  border-radius:10px;Â 
Â  border-left:4px solid var(--primary);Â 
Â  background:#fff;
Â  border:2px solid var(--border);
Â  transition:all 0.2s ease;
Â  box-shadow:0 2px 8px rgba(0,0,0,0.05);
Â  cursor:move;
}
.sop-step:hover{
Â  box-shadow:0 4px 16px rgba(0,0,0,0.1);
}
.sop-step.dragging{opacity:0.5; transform:scale(0.95)}
.sop-step.drag-over{border-color:var(--accent); border-width:3px}

.step-header{display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap}
.step-number{font-weight:800; color:var(--primary); min-width:32px; font-size:16px}
.drag-handle{cursor:grab; color:var(--text-light); font-size:18px; user-select:none}
.drag-handle:active{cursor:grabbing}
.step-title{
Â  flex:1;Â 
Â  font-size:16px;Â 
Â  font-weight:600;Â 
Â  color:var(--text);Â 
Â  border:none;Â 
Â  padding:8px;Â 
Â  background:transparent;
Â  border-radius:6px;
Â  transition:background 0.2s;
Â  min-width:200px;
}
.step-title:focus{background:#f9fafb; outline:2px solid var(--accent); outline-offset:2px}
.step-time{
Â  font-size:13px;Â 
Â  color:var(--text-light);Â 
Â  width:70px;Â 
Â  text-align:center;
Â  border:1px solid var(--border);
Â  border-radius:6px;
Â  padding:6px;
}
.step-dependency{
Â  font-size:12px;
Â  padding:4px 8px;
Â  background:#fef3c7;
Â  color:#92400e;
Â  border-radius:6px;
Â  border:1px solid #fbbf24;
Â  cursor:pointer;
}

.step-controls{display:flex; gap:6px; margin-top:12px; flex-wrap:wrap}
.btn-icon{
Â  width:32px;Â 
Â  height:32px;Â 
Â  padding:0;Â 
Â  font-size:14px;Â 
Â  display:flex;Â 
Â  align-items:center;Â 
Â  justify-content:center;Â 
Â  border-radius:6px;Â 
Â  background:var(--bg);Â 
Â  color:var(--accent);Â 
Â  border:1px solid var(--border);Â 
Â  cursor:pointer;
Â  box-shadow:none;
}
.btn-icon:hover{background:var(--accent); color:#fff; transform:scale(1.1)}
.btn-icon.danger{color:var(--danger)}
.btn-icon.danger:hover{background:var(--danger)}

.note{
Â  font-size:13px;Â 
Â  color:var(--text-light);Â 
Â  margin-top:12px;Â 
Â  padding:12px;Â 
Â  border-radius:8px;Â 
Â  background:#f9fafb;Â 
Â  min-height:32px;
Â  border:1px solid var(--border);
}
.note:focus{outline:2px solid var(--accent); background:#fff}
.note:empty:before{content:attr(data-placeholder); color:#9ca3af}

.step-image{margin-top:12px; position:relative}
.step-image img{max-width:100%; border-radius:8px; border:2px solid var(--border)}
.remove-image{position:absolute; top:8px; right:8px; background:var(--danger); color:#fff; border:none; padding:4px 8px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600}

.approval-section{margin-top:12px; padding:12px; background:#fef3c7; border-radius:8px; border:1px solid #fbbf24}
.approval-section label{display:block; font-size:12px; font-weight:600; color:#92400e; margin-bottom:8px}
.approval-section select{width:100%; padding:6px; border:1px solid #fbbf24; border-radius:6px; background:#fff}
.approval-status{display:inline-block; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600; margin-top:8px}
.approval-status.pending{background:#fef3c7; color:#92400e}
.approval-status.approved{background:#d1fae5; color:#065f46}
.approval-status.rejected{background:#fee2e2; color:#991b1b}

.sidebar-section{margin-bottom:24px; padding-bottom:20px; border-bottom:2px solid var(--border)}
.sidebar-section:last-child{border:none}
.sidebar-section h4{margin:0 0 12px 0; font-size:14px; font-weight:700; color:var(--primary); text-transform:uppercase; letter-spacing:0.5px}
.sidebar button{width:100%; margin-bottom:10px; justify-content:center}
.stat-item{display:flex; justify-content:space-between; padding:10px 0; font-size:14px}
.stat-label{color:var(--text-light)}
.stat-value{font-weight:700; color:var(--accent); font-size:18px}

.version-item{padding:10px; border:1px solid var(--border); border-radius:6px; margin-bottom:8px; cursor:pointer; transition:all 0.2s}
.version-item:hover{background:#f9fafb; border-color:var(--accent)}
.version-date{font-size:12px; color:var(--text-light)}
.version-note{font-size:13px; color:var(--text); margin-top:4px}

.sop-list-item{padding:12px; border:2px solid var(--border); border-radius:8px; margin-bottom:10px; cursor:pointer; transition:all 0.2s; background:#fff}
.sop-list-item:hover{border-color:var(--accent); background:#f0f9ff}
.sop-list-title{font-weight:600; color:var(--primary); margin-bottom:4px}
.sop-list-meta{font-size:12px; color:var(--text-light)}
.sop-list-actions{display:flex; gap:8px; margin-top:8px}
.sop-list-actions button{padding:4px 12px; font-size:12px; margin:0}

.search-box{width:100%; padding:10px; border:2px solid var(--border); border-radius:8px; margin-bottom:16px; font-size:14px}
.search-box:focus{outline:none; border-color:var(--accent)}

.modal{
Â  position:fixed;Â 
Â  left:50%;Â 
Â  top:50%;Â 
Â  transform:translate(-50%,-50%);Â 
Â  background:#fff;Â 
Â  box-shadow:0 20px 60px rgba(0,0,0,0.25);Â 
Â  border-radius:16px;Â 
Â  z-index:1400;Â 
Â  padding:32px;Â 
Â  max-width:700px;
Â  width:90%;
Â  max-height:85vh;Â 
Â  overflow:auto;Â 
Â  display:none;
}
.modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px}
.modal-header h3{margin:0; font-size:24px; color:var(--primary); font-weight:700}
.modal-close{background:transparent; color:var(--text-light); border:none; font-size:28px; cursor:pointer; padding:0; width:32px; height:32px; border-radius:50%; transition:all 0.2s}
.modal-close:hover{background:var(--bg); color:var(--danger); transform:rotate(90deg)}

.modal-overlay{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); z-index:1399; display:none}

.form-group{margin-bottom:16px}
.form-group label{display:block; font-size:14px; font-weight:600; color:var(--text); margin-bottom:8px}
.form-group input, .form-group select, .form-group textarea{width:100%; padding:10px; border:2px solid var(--border); border-radius:8px; font-size:14px; font-family:inherit}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus{outline:none; border-color:var(--accent)}

.toast{position:fixed; right:20px; bottom:20px; background:var(--text); color:#fff; padding:16px 20px; border-radius:10px; opacity:0; z-index:1600; display:none; box-shadow:0 8px 24px rgba(0,0,0,0.3); font-weight:500; transition:opacity 0.3s}
.toast.show{opacity:1; display:block}
.toast.success{background:var(--success)}
.toast.error{background:var(--danger)}

.save-animation{
Â  position:fixed;Â 
Â  top:80px;Â 
Â  right:20px;Â 
Â  background:var(--success);Â 
Â  color:#fff;Â 
Â  padding:12px 20px;Â 
Â  border-radius:10px;Â 
Â  font-size:14px;Â 
Â  z-index:2000;
Â  box-shadow:0 4px 16px rgba(16,185,129,0.4);
Â  font-weight:600;
Â  opacity:0;
Â  transition:opacity 0.3s;
}
.save-animation.show{opacity:1}

.checkbox-group{display:flex; align-items:center; gap:8px; margin-bottom:12px}
.checkbox-group input[type="checkbox"]{width:auto; margin:0}

@media print{
Â  .top-bar, .sidebar, .trust-bar, button, .step-controls{display:none !important}
Â  .editor-panel{max-width:100%; padding:20px}
Â  .sop-step{break-inside:avoid; page-break-inside:avoid}
}

@media(max-width:768px){
Â  .sidebar{position:fixed; left:0; top:auto; bottom:0; height:auto; width:100%; z-index:100; border-left:none; border-top:2px solid var(--border); max-height:70vh}
Â  .main-controls{flex-wrap:wrap; justify-content:center}
Â  .step-header{flex-wrap:wrap}
}
</style>
</head>
<body>

<div class="trust-bar">
Â  <span>â— Secure & Private</span>
Â  <span>âœ“ 100+ Businesses Trust Us</span>
Â  <span>â— Create SOPs in Minutes</span>
</div>

<div class="top-bar">
Â  <div class="logo-area">
Â  Â  <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%231E293B' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='%2306B6D4' font-weight='bold' font-family='sans-serif'%3ED%3C/text%3E%3C/svg%3E" alt="DGS Logo" />
Â  Â  <span>SOP Designer Pro<span class="logo-badge">FREE</span></span>
Â  </div>
Â Â 
Â  <div class="main-controls">
Â  Â  <button id="sop-list-btn" class="secondary" aria-label="View all SOPs">ğŸ“‹ My SOPs</button>
Â  Â  <button id="new-btn" aria-label="Add new step">+ Add Step</button>
Â  Â  <button id="export-menu-btn" style="display:none" class="secondary" aria-label="Export options">â¬‡ Export</button>
Â  Â  <button id="version-btn" style="display:none" class="secondary" aria-label="Version history">ğŸ• History</button>
Â  Â  <button id="consult-btn" class="cta-primary" aria-label="Book free consultation">Free Consultation</button>
Â  Â  <button id="toggle-sidebar" class="secondary" aria-label="Toggle sidebar">â˜°</button>
Â  </div>
</div>

<div class="container">
Â  <div class="editor-panel">
Â  Â  <div id="sop-header" style="display:none" class="sop-header">
Â  Â  Â  <input type="text" id="sop-title-input" class="sop-title" placeholder="SOP Title..." aria-label="SOP Title" />
Â  Â  Â  <div class="sop-meta">
Â  Â  Â  Â  <div class="meta-item">
Â  Â  Â  Â  Â  <span>Department:</span>
Â  Â  Â  Â  Â  <select id="department-select" aria-label="Department">
Â  Â  Â  Â  Â  Â  <option>General</option>
Â  Â  Â  Â  Â  Â  <option>Operations</option>
Â  Â  Â  Â  Â  Â  <option>Sales</option>
Â  Â  Â  Â  Â  Â  <option>Customer Service</option>
Â  Â  Â  Â  Â  Â  <option>HR</option>
Â  Â  Â  Â  Â  Â  <option>Finance</option>
Â  Â  Â  Â  Â  Â  <option>IT</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="meta-item">
Â  Â  Â  Â  Â  <span>Priority:</span>
Â  Â  Â  Â  Â  <select id="priority-select" aria-label="Priority">
Â  Â  Â  Â  Â  Â  <option>Low</option>
Â  Â  Â  Â  Â  Â  <option selected>Medium</option>
Â  Â  Â  Â  Â  Â  <option>High</option>
Â  Â  Â  Â  Â  Â  <option>Critical</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="meta-item">
Â  Â  Â  Â  Â  <span>Last Modified: <strong id="last-modified">Just now</strong></span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="editor" role="main" aria-label="SOP Editor"></div>
Â  </div>
Â Â 
Â  <div class="sidebar hidden" role="complementary" aria-label="Sidebar">
Â  Â  <div class="sidebar-section">
Â  Â  Â  <h4>Statistics</h4>
Â  Â  Â  <div class="stat-item">
Â  Â  Â  Â  <span class="stat-label">Total Time:</span>
Â  Â  Â  Â  <span class="stat-value" id="total-time" aria-label="Total time in minutes">0</span> min
Â  Â  Â  </div>
Â  Â  Â  <div class="stat-item">
Â  Â  Â  Â  <span class="stat-label">Steps:</span>
Â  Â  Â  Â  <span class="stat-value" id="step-count" aria-label="Number of steps">0</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="stat-item">
Â  Â  Â  Â  <span class="stat-label">Approvals:</span>
Â  Â  Â  Â  <span class="stat-value" id="approval-count" aria-label="Pending approvals">0</span>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="sidebar-section">
Â  Â  Â  <h4>Quick Actions</h4>
Â  Â  Â  <button id="save-template-btn" aria-label="Save as template">ğŸ’¾ Save as Template</button>
Â  Â  Â  <button id="import-btn" aria-label="Import SOP">ğŸ“¥ Import SOP</button>
Â  Â  Â  <button id="print-btn" aria-label="Print SOP">ğŸ–¨ï¸ Print</button>
Â  Â  Â  <button id="email-btn" aria-label="Share via email">âœ‰ï¸ Email</button>
Â  Â  </div>
Â  </div>
</div>

<div class="modal-overlay" id="modalOverlay"></div>

<div class="modal" id="sopListModal" role="dialog" aria-labelledby="sopListTitle">
Â  <div class="modal-header">
Â  Â  <h3 id="sopListTitle">My SOPs</h3>
Â  Â  <button class="modal-close" aria-label="Close modal">Ã—</button>
Â  </div>
Â  <input type="text" id="sop-search" class="search-box" placeholder="Search SOPs..." aria-label="Search SOPs" />
Â  <button id="create-new-sop-btn" class="cta-primary" style="width:100%; margin-bottom:16px">+ Create New SOP</button>
Â  <div id="sop-list" role="list"></div>
</div>

<div class="modal" id="templateModal" role="dialog" aria-labelledby="templateTitle">
Â  <div class="modal-header">
Â  Â  <h3 id="templateTitle">Choose a Template</h3>
Â  Â  <button class="modal-close" aria-label="Close modal">Ã—</button>
Â  </div>
Â  <p style="color:var(--text-light); margin-bottom:20px">Start with a pre-built template or create from scratch</p>
Â  <div class="template-grid" id="templateGrid"></div>
Â  <button id="blank-sop-btn" style="width:100%; margin-top:20px" class="secondary">Start Blank SOP</button>
</div>

<div class="modal" id="exportModal" role="dialog" aria-labelledby="exportTitle">
Â  <div class="modal-header">
Â  Â  <h3 id="exportTitle">Export Options</h3>
Â  Â  <button class="modal-close" aria-label="Close modal">Ã—</button>
Â  </div>
Â  <div style="display:grid; gap:12px">
Â  Â  <button id="pdf-btn" aria-label="Export as PDF">ğŸ“„ Export as PDF</button>
Â  Â  <button id="html-btn" aria-label="Export as HTML">ğŸŒ Export as HTML</button>
Â  Â  <button id="markdown-btn" aria-label="Export as Markdown">ğŸ“ Export as Markdown</button>
Â  Â  <button id="json-btn" aria-label="Export as JSON">ğŸ’¾ Export as JSON</button>
Â  Â  <button id="csv-btn" aria-label="Export as CSV">ğŸ“Š Export as CSV</button>
Â  </div>
</div>

<div class="modal" id="versionModal" role="dialog" aria-labelledby="versionTitle">
Â  <div class="modal-header">
Â  Â  <h3 id="versionTitle">Version History</h3>
Â  Â  <button class="modal-close" aria-label="Close modal">Ã—</button>
Â  </div>
Â  <div id="version-list" role="list"></div>
</div>

<div class="modal" id="saveTemplateModal" role="dialog" aria-labelledby="saveTemplateTitle">
Â  <div class="modal-header">
Â  Â  <h3 id="saveTemplateTitle">Save as Template</h3>
Â  Â  <button class="modal-close" aria-label="Close modal">Ã—</button>
Â  </div>
Â  <div class="form-group">
Â  Â  <label for="template-name">Template Name</label>
Â  Â  <input type="text" id="template-name" placeholder="e.g., Opening Procedure" required />
Â  </div>
Â  <div class="form-group">
Â  Â  <label for="template-desc">Description</label>
Â  Â  <textarea id="template-desc" rows="3" placeholder="Brief description of this template"></textarea>
Â  </div>
Â  <button id="save-template-confirm" class="cta-primary" style="width:100%">Save Template</button>
</div>

<div class="modal" id="dependencyModal" role="dialog" aria-labelledby="dependencyTitle">
Â  <div class="modal-header">
Â  Â  <h3 id="dependencyTitle">Set Prerequisite Steps</h3>
Â  Â  <button class="modal-close" aria-label="Close modal">Ã—</button>
Â  </div>
Â  <p style="color:var(--text-light); margin-bottom:16px">Select which steps must be completed before this one</p>
Â  <div id="dependency-list"></div>
Â  <button id="save-dependency-btn" class="cta-primary" style="width:100%; margin-top:16px">Save</button>
</div>

<div class="modal" id="emailModal" role="dialog" aria-labelledby="emailTitle">
Â  <div class="modal-header">
Â  Â  <h3 id="emailTitle">Share via Email</h3>
Â  Â  <button class="modal-close" aria-label="Close modal">Ã—</button>
Â  </div>
Â  <div class="form-group">
Â  Â  <label for="email-to">To (comma-separated emails)</label>
Â  Â  <input type="text" id="email-to" placeholder="email1@example.com, email2@example.com" />
Â  </div>
Â  <div class="form-group">
Â  Â  <label for="email-message">Message (optional)</label>
Â  Â  <textarea id="email-message" rows="4" placeholder="Add a personal message..."></textarea>
Â  </div>
Â  <button id="send-email-btn" class="cta-primary" style="width:100%">Generate Email</button>
</div>

<div class="modal" id="consultModal" role="dialog" aria-labelledby="consultTitle">
Â  <div class="modal-header">
Â  Â  <h3 id="consultTitle">Book Your Free Strategy Call</h3>
Â  Â  <button class="modal-close" aria-label="Close modal">Ã—</button>
Â  </div>
Â Â 
Â  <div style="background:linear-gradient(135deg, #f0f9ff 0%, #faf5ff 100%); padding:20px; border-radius:12px; margin-bottom:20px">
Â  Â  <p style="margin:0; font-size:16px; color:var(--text); line-height:1.6"><strong>In this 15-minute call, we'll:</strong></p>
Â  Â  <ul style="margin:12px 0 0 0; padding-left:20px; color:var(--text)">
Â  Â  Â  <li>Review your current processes</li>
Â  Â  Â  <li>Identify operational gaps</li>
Â  Â  Â  <li>Show you how to reduce training time by 60%</li>
Â  Â  Â  <li>Provide a custom roadmap</li>
Â  Â  </ul>
Â  </div>
Â Â 
Â  <button id="schedule-call-btn" class="cta-primary" style="width:100%; box-shadow:none; margin-top:20px">Schedule My Free Call</button>
</div>

<div id="toast" class="toast" role="alert" aria-live="polite"></div>
<div id="saveAnim" class="save-animation" role="status" aria-live="polite">âœ“ Saved</div>

<input type="file" id="image-input" accept="image/*" style="display:none" aria-label="Upload image" />
<input type="file" id="import-input" accept=".json,.csv" style="display:none" aria-label="Import file" />

<script>
// State Management
currentSOPId = null;
let allSOPs = {};
let customTemplates = {};
let versionHistory = [];
let draggedElement = null;
let currentStepForDependency = null;

const editor = document.getElementById('editor');

// Utility Functions
function showToast(msg, type = 'success') {
Â  const toast = document.getElementById('toast');
Â  toast.textContent = msg;
Â  toast.className = 'toast show ' + type;
Â  setTimeout(() => toast.classList.remove('show'), 3000);
}

function closeAllModals() {
Â  document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
Â  document.getElementById('modalOverlay').style.display = 'none';
}

function showModal(id) {
Â  document.getElementById('modalOverlay').style.display = 'block';
Â  document.getElementById(id).style.display = 'block';
}

function generateId() {
Â  return 'sop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// SOP Step Creation with Drag & Drop
function createStep(title = '', time = '', note = '', dependencies = [], imageUrl = '', approver = '', approvalStatus = 'pending') {
Â  const step = document.createElement('div');
Â  step.className = 'sop-step';
Â  step.draggable = true;
Â  step.setAttribute('role', 'article');
Â Â 
Â  const depText = dependencies.length > 0 ? `<span class="step-dependency" role="button" tabindex="0" aria-label="Has ${dependencies.length} prerequisite steps">âš  ${dependencies.length} Prerequisites</span>` : '';
Â Â 
Â  step.innerHTML = `
Â  Â  <div class="step-header">
Â  Â  Â  <span class="drag-handle" aria-label="Drag to reorder">â‹®â‹®</span>
Â  Â  Â  <span class="step-number">1</span>
Â  Â  Â  <input type="text" class="step-title" placeholder="Step title..." value="${title}" aria-label="Step title" />
Â  Â  Â  <input type="number" class="step-time" min="0" placeholder="0" value="${time}" aria-label="Time in minutes" />
Â  Â  Â  ${depText}
Â  Â  </div>
Â  Â  <div class="step-controls">
Â  Â  Â  <button class="btn-icon" title="Add Image" data-action="image" aria-label="Add image">ğŸ–¼ï¸</button>
Â  Â  Â  <button class="btn-icon" title="Add Prerequisite" data-action="dependency" aria-label="Add prerequisite">ğŸ”—</button>
Â  Â  Â  <button class="btn-icon" title="Add Approval" data-action="approval" aria-label="Add approval workflow">âœ“</button>
Â  Â  Â  <button class="btn-icon danger delete-btn" title="Delete" aria-label="Delete step">âœ–</button>
Â  Â  </div>
Â  Â  <div class="note" contenteditable="true" data-placeholder="Add notes, instructions, or details..." role="textbox" aria-label="Step notes">${note}</div>
Â  Â  ${imageUrl ? `<div class="step-image"><img src="${imageUrl}" alt="Step illustration" /><button class="remove-image" aria-label="Remove image">âœ–</button></div>` : ''}
Â  Â  ${approver ? `<div class="approval-section">
Â  Â  Â  <label>Approval Required</label>
Â  Â  Â  <select class="approval-select" aria-label="Approver">
Â  Â  Â  Â  <option ${approver === 'Manager' ? 'selected' : ''}>Manager</option>
Â  Â  Â  Â  <option ${approver === 'Supervisor' ? 'selected' : ''}>Supervisor</option>
Â  Â  Â  Â  <option ${approver === 'Team Lead' ? 'selected' : ''}>Team Lead</option>
Â  Â  Â  Â  <option ${approver === 'Director' ? 'selected' : ''}>Director</option>
Â  Â  Â  </select>
Â  Â  Â  <span class="approval-status ${approvalStatus}">${approvalStatus.toUpperCase()}</span>
Â  Â  </div>` : ''}
Â  `;
Â Â 
Â  // Store dependencies
Â  step.dataset.dependencies = JSON.stringify(dependencies);
Â Â 
Â  // Event Listeners
Â  step.querySelector('.delete-btn').addEventListener('click', () => deleteStep(step));
Â  step.querySelector('.step-title').addEventListener('input', () => saveSOP());
Â  step.querySelector('.step-time').addEventListener('input', () => { updateStats(); saveSOP(); });
Â  step.querySelector('.note').addEventListener('input', () => saveSOP());
Â Â 
Â  // Action buttons
Â  step.querySelectorAll('[data-action]').forEach(btn => {
Â  Â  btn.addEventListener('click', (e) => handleStepAction(e.target.dataset.action, step));
Â  });
Â Â 
Â  // Dependency click
Â  const depSpan = step.querySelector('.step-dependency');
Â  if (depSpan) {
Â  Â  depSpan.addEventListener('click', () => handleStepAction('dependency', step));
Â  Â  depSpan.addEventListener('keypress', (e) => {
Â  Â  Â  if (e.key === 'Enter' || e.key === ' ') handleStepAction('dependency', step);
Â  Â  });
Â  }
Â Â 
Â  // Remove image
Â  const removeImg = step.querySelector('.remove-image');
Â  if (removeImg) {
Â  Â  removeImg.addEventListener('click', () => {
Â  Â  Â  step.querySelector('.step-image').remove();
Â  Â  Â  saveSOP();
Â  Â  });
Â  }
Â Â 
Â  // Approval select
Â  const approvalSelect = step.querySelector('.approval-select');
Â  if (approvalSelect) {
Â  Â  approvalSelect.addEventListener('change', () => saveSOP());
Â  }
Â Â 
Â  // Drag events
Â  step.addEventListener('dragstart', handleDragStart);
Â  step.addEventListener('dragend', handleDragEnd);
Â  step.addEventListener('dragover', handleDragOver);
Â  step.addEventListener('drop', handleDrop);
Â  step.addEventListener('dragleave', handleDragLeave);
Â Â 
Â  return step;
}

// Drag and Drop Handlers
function handleDragStart(e) {
Â  draggedElement = this;
Â  this.classList.add('dragging');
Â  e.dataTransfer.effectAllowed = 'move';
Â  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
Â  this.classList.remove('dragging');
Â  document.querySelectorAll('.sop-step').forEach(step => {
Â  Â  step.classList.remove('drag-over');
Â  });
}

function handleDragOver(e) {
Â  if (e.preventDefault) e.preventDefault();
Â  e.dataTransfer.dropEffect = 'move';
Â Â 
Â  const afterElement = getDragAfterElement(editor, e.clientY);
Â  if (afterElement == null) {
Â  Â  editor.appendChild(draggedElement);
Â  } else {
Â  Â  editor.insertBefore(draggedElement, afterElement);
Â  }
Â Â 
Â  return false;
}

function handleDrop(e) {
Â  if (e.stopPropagation) e.stopPropagation();
Â  renumber();
Â  updateStats();
Â  saveSOP();
Â  return false;
}

function handleDragLeave(e) {
Â  this.classList.remove('drag-over');
}

function getDragAfterElement(container, y) {
Â  const draggableElements = [...container.querySelectorAll('.sop-step:not(.dragging)')];
Â Â 
Â  return draggableElements.reduce((closest, child) => {
Â  Â  const box = child.getBoundingClientRect();
Â  Â  const offset = y - box.top - box.height / 2;
Â  Â Â 
Â  Â  if (offset < 0 && offset > closest.offset) {
Â  Â  Â  return { offset: offset, element: child };
Â  Â  } else {
Â  Â  Â  return closest;
Â  Â  }
Â  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Step Actions
function handleStepAction(action, step) {
Â  switch(action) {
Â  Â  case 'image':
Â  Â  Â  currentStepForDependency = step;
Â  Â  Â  document.getElementById('image-input').click();
Â  Â  Â  break;
Â  Â  case 'dependency':
Â  Â  Â  openDependencyModal(step);
Â  Â  Â  break;
Â  Â  case 'approval':
Â  Â  Â  addApproval(step);
Â  Â  Â  break;
Â  }
}

function addApproval(step) {
Â  if (step.querySelector('.approval-section')) {
Â  Â  showToast('Approval already added', 'error');
Â  Â  return;
Â  }
Â Â 
Â  const approvalHTML = `<div class="approval-section">
Â  Â  <label>Approval Required</label>
Â  Â  <select class="approval-select" aria-label="Approver">
Â  Â  Â  <option>Manager</option>
Â  Â  Â  <option>Supervisor</option>
Â  Â  Â  <option>Team Lead</option>
Â  Â  Â  <option>Director</option>
Â  Â  </select>
Â  Â  <span class="approval-status pending">PENDING</span>
Â  </div>`;
Â Â 
Â  step.querySelector('.note').insertAdjacentHTML('afterend', approvalHTML);
Â  step.querySelector('.approval-select').addEventListener('change', () => saveSOP());
Â  updateStats();
Â  saveSOP();
Â  showToast('Approval workflow added');
}

function openDependencyModal(step) {
Â  currentStepForDependency = step;
Â  const depList = document.getElementById('dependency-list');
Â  depList.innerHTML = '';
Â Â 
Â  const steps = editor.querySelectorAll('.sop-step');
Â  const currentDeps = JSON.parse(step.dataset.dependencies || '[]');
Â Â 
Â  steps.forEach((s, idx) => {
Â  Â  if (s === step) return;
Â  Â Â 
Â  Â  const title = s.querySelector('.step-title').value || `Step ${idx + 1}`;
Â  Â  const checked = currentDeps.includes(idx) ? 'checked' : '';
Â  Â Â 
Â  Â  depList.innerHTML += `
Â  Â  Â  <div class="checkbox-group">
Â  Â  Â  Â  <input type="checkbox" id="dep-${idx}" value="${idx}" ${checked} />
Â  Â  Â  Â  <label for="dep-${idx}">${idx + 1}. ${title}</label>
Â  Â  Â  </div>
Â  Â  `;
Â  });
Â Â 
Â  showModal('dependencyModal');
}

function saveDependencies() {
Â  if (!currentStepForDependency) return;
Â Â 
Â  const checkboxes = document.querySelectorAll('#dependency-list input:checked');
Â  const dependencies = Array.from(checkboxes).map(cb => parseInt(cb.value));
Â Â 
Â  currentStepForDependency.dataset.dependencies = JSON.stringify(dependencies);
Â Â 
Â  // Update UI
Â  const existingDep = currentStepForDependency.querySelector('.step-dependency');
Â  if (dependencies.length > 0) {
Â  Â  const depHTML = `<span class="step-dependency" role="button" tabindex="0" aria-label="Has ${dependencies.length} prerequisite steps">âš  ${dependencies.length} Prerequisites</span>`;
Â  Â  if (existingDep) {
Â  Â  Â  existingDep.outerHTML = depHTML;
Â  Â  } else {
Â  Â  Â  currentStepForDependency.querySelector('.step-header').insertAdjacentHTML('beforeend', depHTML);
Â  Â  }
Â  Â  const newDep = currentStepForDependency.querySelector('.step-dependency');
Â  Â  newDep.addEventListener('click', () => handleStepAction('dependency', currentStepForDependency));
Â  } else if (existingDep) {
Â  Â  existingDep.remove();
Â  }
Â Â 
Â  saveSOP();
Â  closeAllModals();
Â  showToast('Prerequisites updated');
}

// Image Upload
document.getElementById('image-input').addEventListener('change', (e) => {
Â  const file = e.target.files[0];
Â  if (!file || !currentStepForDependency) return;
Â Â 
Â  const reader = new FileReader();
Â  reader.onload = (event) => {
Â  Â  const existingImg = currentStepForDependency.querySelector('.step-image');
Â  Â  if (existingImg) existingImg.remove();
Â  Â Â 
Â  Â  const imgHTML = `<div class="step-image"><img src="${event.target.result}" alt="Step illustration" /><button class="remove-image" aria-label="Remove image">âœ–</button></div>`;
Â  Â  currentStepForDependency.querySelector('.note').insertAdjacentHTML('afterend', imgHTML);
Â  Â Â 
Â  Â  currentStepForDependency.querySelector('.remove-image').addEventListener('click', () => {
Â  Â  Â  currentStepForDependency.querySelector('.step-image').remove();
Â  Â  Â  saveSOP();
Â  Â  });
Â  Â Â 
Â  Â  saveSOP();
Â  Â  showToast('Image added');
Â  };
Â  reader.readAsDataURL(file);
});

// Main SOP Logic
function newSOP(templateData = null) {
Â  currentSOPId = generateId();
Â  document.getElementById('sop-header').style.display = 'block';
Â  document.getElementById('export-menu-btn').style.display = 'inline-block';
Â  document.getElementById('version-btn').style.display = 'inline-block';
Â  editor.innerHTML = '';
Â Â 
Â  const now = new Date().toLocaleString();
Â  document.getElementById('last-modified').textContent = now;

Â  if (templateData) {
Â  Â  document.getElementById('sop-title-input').value = templateData.title || 'New SOP from Template';
Â  Â  document.getElementById('department-select').value = templateData.department || 'General';
Â  Â  document.getElementById('priority-select').value = templateData.priority || 'Medium';
Â  Â Â 
Â  Â  templateData.steps.forEach(step => {
Â  Â  Â  editor.appendChild(createStep(
Â  Â  Â  Â  step.title, 
Â  Â  Â  Â  step.time, 
Â  Â  Â  Â  step.note, 
Â  Â  Â  Â  step.dependencies, 
Â  Â  Â  Â  step.imageUrl, 
Â  Â  Â  Â  step.approver,
Â  Â  Â  Â  step.approvalStatus
Â  Â  Â  ));
Â  Â  });
Â  Â  showToast(`SOP created from '${templateData.title}' template`);
Â  } else {
Â  Â  document.getElementById('sop-title-input').value = 'New Blank SOP';
Â  Â  document.getElementById('department-select').value = 'General';
Â  Â  document.getElementById('priority-select').value = 'Medium';
Â  Â  editor.appendChild(createStep('Initial Step'));
Â  Â  showToast('New blank SOP created');
Â  }
Â Â 
Â  updateStats();
Â  renumber();
Â  saveSOP();
Â  closeAllModals();
}

function deleteStep(step) {
Â  const title = step.querySelector('.step-title').value;
Â  if (confirm(`Are you sure you want to delete the step: "${title}"?`)) {
Â  Â  step.remove();
Â  Â  renumber();
Â  Â  updateStats();
Â  Â  saveSOP();
Â  Â  showToast('Step deleted', 'error');
Â  }
}

function renumber() {
Â  editor.querySelectorAll('.sop-step').forEach((step, index) => {
Â  Â  step.querySelector('.step-number').textContent = index + 1;
Â  });
}

function updateStats() {
Â  let totalTime = 0;
Â  let approvalCount = 0;
Â  const steps = editor.querySelectorAll('.sop-step');
Â Â 
Â  steps.forEach(step => {
Â  Â  const timeInput = step.querySelector('.step-time');
Â  Â  totalTime += parseInt(timeInput.value || 0);
Â  Â Â 
Â  Â  if (step.querySelector('.approval-section')) {
Â  Â  Â  approvalCount++;
Â  Â  }
Â  });
Â Â 
Â  document.getElementById('total-time').textContent = totalTime;
Â  document.getElementById('step-count').textContent = steps.length;
Â  document.getElementById('approval-count').textContent = approvalCount;
}

function collectSOPData() {
Â  const steps = Array.from(editor.querySelectorAll('.sop-step')).map(step => ({
Â  Â  title: step.querySelector('.step-title').value,
Â  Â  time: step.querySelector('.step-time').value,
Â  Â  note: step.querySelector('.note').innerHTML,
Â  Â  dependencies: JSON.parse(step.dataset.dependencies || '[]'),
Â  Â  imageUrl: step.querySelector('.step-image img')?.src || '',
Â  Â  approver: step.querySelector('.approval-select')?.value || '',
Â  Â  approvalStatus: step.querySelector('.approval-status')?.classList.contains('approved') ? 'approved' : step.querySelector('.approval-status')?.classList.contains('rejected') ? 'rejected' : 'pending'
Â  }));
Â Â 
Â  return {
Â  Â  id: currentSOPId,
Â  Â  title: document.getElementById('sop-title-input').value,
Â  Â  department: document.getElementById('department-select').value,
Â  Â  priority: document.getElementById('priority-select').value,
Â  Â  lastModified: new Date().toISOString(),
Â  Â  steps: steps
Â  };
}

// Data Persistence (Using simplified local storage)
function saveSOP(isVersion = true) {
Â  if (!currentSOPId) return;
Â Â 
Â  const sopData = collectSOPData();
Â  allSOPs[currentSOPId] = sopData;
Â Â 
Â  // Update last modified
Â  const now = new Date().toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
Â  document.getElementById('last-modified').textContent = now;

Â  // Simple versioning (only save if a major change or explicit save)
Â  if (isVersion) {
Â  Â  const currentVersion = {
Â  Â  Â  date: sopData.lastModified,
Â  Â  Â  note: `Auto-saved. Steps: ${sopData.steps.length}, Time: ${document.getElementById('total-time').textContent} min`
Â  Â  };
Â  Â  if (versionHistory.length === 0 || new Date(versionHistory[0].date).getTime() < (Date.now() - 30000)) { // Save new version every 30s
Â  Â  Â  versionHistory.unshift(currentVersion);
Â  Â  Â  if (versionHistory.length > 10) versionHistory.pop();
Â  Â  } else {
Â  Â  Â  versionHistory[0] = currentVersion; // Update the last auto-save
Â  Â  }
Â  }
Â Â 
Â  localStorage.setItem('allSOPs', JSON.stringify(allSOPs));
Â  localStorage.setItem('customTemplates', JSON.stringify(customTemplates));
Â  localStorage.setItem(`versionHistory_${currentSOPId}`, JSON.stringify(versionHistory));
Â Â 
Â  // Show a quick save animation
Â  const saveAnim = document.getElementById('saveAnim');
Â  saveAnim.classList.add('show');
Â  setTimeout(() => saveAnim.classList.remove('show'), 1500);
}

function loadSOP(id) {
Â  if (!allSOPs[id]) return;
Â Â 
Â  currentSOPId = id;
Â  const sopData = allSOPs[id];
Â  versionHistory = JSON.parse(localStorage.getItem(`versionHistory_${id}`) || '[]');

Â  editor.innerHTML = '';
Â  document.getElementById('sop-header').style.display = 'block';
Â  document.getElementById('export-menu-btn').style.display = 'inline-block';
Â  document.getElementById('version-btn').style.display = 'inline-block';
Â Â 
Â  document.getElementById('sop-title-input').value = sopData.title;
Â  document.getElementById('department-select').value = sopData.department;
Â  document.getElementById('priority-select').value = sopData.priority;
Â  document.getElementById('last-modified').textContent = new Date(sopData.lastModified).toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

Â  sopData.steps.forEach(step => {
Â  Â  editor.appendChild(createStep(
Â  Â  Â  step.title, 
Â  Â  Â  step.time, 
Â  Â  Â  step.note, 
Â  Â  Â  step.dependencies, 
Â  Â  Â  step.imageUrl, 
Â  Â  Â  step.approver,
Â  Â  Â  step.approvalStatus
Â  Â  ));
Â  });
Â Â 
Â  updateStats();
Â  renumber();
Â  closeAllModals();
Â  showToast(`Loaded SOP: ${sopData.title}`);
}

function loadInitialData() {
Â  allSOPs = JSON.parse(localStorage.getItem('allSOPs') || '{}');
Â  customTemplates = JSON.parse(localStorage.getItem('customTemplates') || '{}');
Â Â 
Â  if (Object.keys(allSOPs).length > 0) {
Â  Â  const latestId = Object.keys(allSOPs).sort((a, b) => new Date(allSOPs[b].lastModified) - new Date(allSOPs[a].lastModified))[0];
Â  Â  loadSOP(latestId);
Â  } else {
Â  Â  // Show empty state if no SOPs exist
Â  Â  editor.innerHTML = `
Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  <h2>Design Your SOP in Minutes</h2>
Â  Â  Â  Â  <p>Get started by choosing a template or creating a new SOP from scratch.</p>
Â  Â  Â  Â  <button id="open-template-btn" class="cta-primary">ğŸš€ Start with a Template</button>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  document.getElementById('open-template-btn').addEventListener('click', () => showModal('templateModal'));
Â  Â  updateStats(); // Reset stats to 0
Â  }
}

// Modal Content Renderers
function renderTemplateGrid() {
Â  const grid = document.getElementById('templateGrid');
Â  grid.innerHTML = '';
Â Â 
Â  // Pre-defined templates
Â  const defaultTemplates = {
Â  Â  'onboarding': { title: 'Employee Onboarding', steps: 6, desc: 'A step-by-step guide for new hires.', department: 'HR' },
Â  Â  'sales-call': { title: 'Sales Discovery Call', steps: 5, desc: 'Structured approach for first sales contact.', department: 'Sales' },
Â  Â  'incident-response': { title: 'IT Incident Response', steps: 8, desc: 'Protocol for critical system failures.', department: 'IT' },
Â  Â  'cash-close': { title: 'Daily Cash Closing', steps: 4, desc: 'End-of-day reconciliation procedure.', department: 'Finance' }
Â  };
Â Â 
Â  // Function to create template card HTML
Â  const createCard = (key, data, isCustom = false) => {
Â  Â  const card = document.createElement('div');
Â  Â  card.className = `template-card ${isCustom ? 'custom-template' : ''}`;
Â  Â  card.dataset.key = key;
Â  Â  card.innerHTML = `
Â  Â  Â  <h5 class="template-card-title">${data.title}</h5>
Â  Â  Â  <p class="template-card-desc">${data.desc}</p>
Â  Â  Â  <span class="template-card-steps">${data.steps} Steps</span>
Â  Â  Â  ${isCustom ? `<button class="template-delete" aria-label="Delete template" data-key="${key}">âœ–</button>` : ''}
Â  Â  `;
Â  Â  card.addEventListener('click', (e) => {
Â  Â  Â  if (e.target.classList.contains('template-delete')) return;
Â  Â  Â  const template = isCustom ? customTemplates[key] : defaultTemplates[key];
Â  Â  Â  newSOP(template);
Â  Â  });
Â  Â  grid.appendChild(card);
Â  Â Â 
Â  Â  if (isCustom) {
Â  Â  Â  card.querySelector('.template-delete').addEventListener('click', (e) => {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  delete customTemplates[key];
Â  Â  Â  Â  localStorage.setItem('customTemplates', JSON.stringify(customTemplates));
Â  Â  Â  Â  renderTemplateGrid();
Â  Â  Â  Â  showToast('Custom template deleted', 'error');
Â  Â  Â  });
Â  Â  }
Â  };

Â  // Add custom templates first
Â  for (const key in customTemplates) {
Â  Â  createCard(key, customTemplates[key], true);
Â  }

Â  // Add default templates
Â  for (const key in defaultTemplates) {
Â  Â  createCard(key, defaultTemplates[key]);
Â  }
}

function renderSOPList(filter = '') {
Â  const list = document.getElementById('sop-list');
Â  list.innerHTML = '';
Â Â 
Â  const sortedSOPs = Object.values(allSOPs).sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
Â Â 
Â  sortedSOPs.filter(sop => sop.title.toLowerCase().includes(filter.toLowerCase())).forEach(sop => {
Â  Â  const listItem = document.createElement('div');
Â  Â  listItem.className = 'sop-list-item';
Â  Â  listItem.setAttribute('role', 'listitem');
Â  Â  listItem.innerHTML = `
Â  Â  Â  <div class="sop-list-title">${sop.title}</div>
Â  Â  Â  <div class="sop-list-meta">
Â  Â  Â  Â  ${sop.department} | Priority: ${sop.priority} | Steps: ${sop.steps.length} | Last Edit: ${new Date(sop.lastModified).toLocaleDateString()}
Â  Â  Â  </div>
Â  Â  Â  <div class="sop-list-actions">
Â  Â  Â  Â  <button class="secondary load-sop-btn" data-id="${sop.id}">Open</button>
Â  Â  Â  Â  <button class="danger delete-sop-btn" data-id="${sop.id}">Delete</button>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  list.appendChild(listItem);
Â  });

Â  document.querySelectorAll('.load-sop-btn').forEach(btn => {
Â  Â  btn.addEventListener('click', (e) => loadSOP(e.target.dataset.id));
Â  });
Â Â 
Â  document.querySelectorAll('.delete-sop-btn').forEach(btn => {
Â  Â  btn.addEventListener('click', (e) => {
Â  Â  Â  const id = e.target.dataset.id;
Â  Â  Â  if (confirm(`Are you sure you want to permanently delete SOP: "${allSOPs[id].title}"?`)) {
Â  Â  Â  Â  delete allSOPs[id];
Â  Â  Â  Â  localStorage.setItem('allSOPs', JSON.stringify(allSOPs));
Â  Â  Â  Â  if (currentSOPId === id) {
Â  Â  Â  Â  Â  newSOP(null); // Load a blank SOP if current one is deleted
Â  Â  Â  Â  }
Â  Â  Â  Â  renderSOPList();
Â  Â  Â  Â  showToast('SOP Deleted', 'error');
Â  Â  Â  }
Â  Â  });
Â  });
}

function renderVersionHistory() {
Â  const list = document.getElementById('version-list');
Â  list.innerHTML = '';
Â Â 
Â  if (versionHistory.length === 0) {
Â  Â  list.innerHTML = `<p style="color:var(--text-light)">No version history available for this SOP yet.</p>`;
Â  Â  return;
Â  }

Â  versionHistory.forEach((version, index) => {
Â  Â  const item = document.createElement('div');
Â  Â  item.className = 'version-item';
Â  Â  item.setAttribute('role', 'listitem');
Â  Â  item.innerHTML = `
Â  Â  Â  <div>Version ${versionHistory.length - index} ${index === 0 ? '(Current)' : ''}</div>
Â  Â  Â  <div class="version-date">${new Date(version.date).toLocaleString()}</div>
Â  Â  Â  <div class="version-note">${version.note}</div>
Â  Â  `;
Â  Â  // Add functionality to revert/view history if needed
Â  Â  list.appendChild(item);
Â  });
}


// Export Logic
function exportAsPDF() {
Â  showToast('Generating PDF...', 'success');
Â  setTimeout(() => {
Â  Â  // Simple print for PDF in browser
Â  Â  window.print();
Â  Â  closeAllModals();
Â  Â  showToast('PDF generated (using browser print)');
Â  }, 500);
}

function exportAsJSON() {
Â  const sopData = collectSOPData();
Â  const dataStr = JSON.stringify(sopData, null, 2);
Â  const blob = new Blob([dataStr], { type: 'application/json' });
Â  const url = URL.createObjectURL(blob);
Â  const a = document.createElement('a');
Â  a.href = url;
Â  a.download = `${sopData.title.replace(/\s/g, '_')}.json`;
Â  document.body.appendChild(a);
Â  a.click();
Â  document.body.removeChild(a);
Â  closeAllModals();
Â  showToast('Exported as JSON');
}

// Event Listeners Initialization
document.addEventListener('DOMContentLoaded', () => {
Â  loadInitialData();
Â Â 
Â  // Top Bar Controls
Â  document.getElementById('new-btn').addEventListener('click', () => editor.appendChild(createStep()));
Â  document.getElementById('sop-list-btn').addEventListener('click', () => {
Â  Â  renderSOPList();
Â  Â  showModal('sopListModal');
Â  });
Â  document.getElementById('export-menu-btn').addEventListener('click', () => showModal('exportModal'));
Â  document.getElementById('version-btn').addEventListener('click', () => {
Â  Â  renderVersionHistory();
Â  Â  showModal('versionModal');
Â  });
Â  document.getElementById('consult-btn').addEventListener('click', () => showModal('consultModal'));
Â  document.getElementById('toggle-sidebar').addEventListener('click', () => {
Â  Â  document.querySelector('.sidebar').classList.toggle('hidden');
Â  });

Â  // Header Inputs
Â  document.getElementById('sop-title-input').addEventListener('input', () => saveSOP());
Â  document.getElementById('department-select').addEventListener('change', () => saveSOP());
Â  document.getElementById('priority-select').addEventListener('change', () => saveSOP());
Â Â 
Â  // Modals
Â  document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', closeAllModals));
Â  document.getElementById('modalOverlay').addEventListener('click', closeAllModals);

Â  // SOP List Modal
Â  document.getElementById('create-new-sop-btn').addEventListener('click', () => showModal('templateModal'));
Â  document.getElementById('sop-search').addEventListener('input', (e) => renderSOPList(e.target.value));

Â  // Template Modal
Â  document.getElementById('blank-sop-btn').addEventListener('click', () => newSOP(null));
Â  document.getElementById('open-template-btn')?.addEventListener('click', () => showModal('templateModal'));

Â  // Dependency Modal
Â  document.getElementById('save-dependency-btn').addEventListener('click', saveDependencies);
Â Â 
Â  // Export Modal
Â  document.getElementById('pdf-btn').addEventListener('click', exportAsPDF);
Â  document.getElementById('json-btn').addEventListener('click', exportAsJSON);
Â  document.getElementById('html-btn').addEventListener('click', () => showToast('HTML Export not yet implemented', 'error'));
Â  document.getElementById('markdown-btn').addEventListener('click', () => showToast('Markdown Export not yet implemented', 'error'));
Â  document.getElementById('csv-btn').addEventListener('click', () => showToast('CSV Export not yet implemented', 'error'));
Â Â 
Â  // Sidebar Actions
Â  document.getElementById('print-btn').addEventListener('click', () => window.print());
Â  document.getElementById('email-btn').addEventListener('click', () => showModal('emailModal'));
Â  document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-input').click());
Â Â 
Â  // Save Template Modal
Â  document.getElementById('save-template-btn').addEventListener('click', () => {
Â  Â  const currentTitle = document.getElementById('sop-title-input').value;
Â  Â  document.getElementById('template-name').value = currentTitle;
Â  Â  showModal('saveTemplateModal');
Â  });

Â  document.getElementById('save-template-confirm').addEventListener('click', () => {
Â  Â  const templateName = document.getElementById('template-name').value;
Â  Â  const templateDesc = document.getElementById('template-desc').value;
Â  Â Â 
Â  Â  if (!templateName) {
Â  Â  Â  showToast('Template name is required', 'error');
Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  const templateData = collectSOPData();
Â  Â  templateData.title = templateName;
Â  Â  templateData.desc = templateDesc;
Â  Â  templateData.steps = templateData.steps.map(step => ({
Â  Â  Â  title: step.title,
Â  Â  Â  time: step.time,
Â  Â  Â  note: step.note,
Â  Â  Â  dependencies: step.dependencies,
Â  Â  Â  imageUrl: '', // Clear images for templates
Â  Â  Â  approver: step.approver
Â  Â  }));
Â  Â  templateData.steps = templateData.steps.length; // Save step count for display
Â  Â Â 
Â  Â  customTemplates['custom_' + generateId()] = templateData;
Â  Â  localStorage.setItem('customTemplates', JSON.stringify(customTemplates));
Â  Â  closeAllModals();
Â  Â  showToast(`Template "${templateName}" saved!`);
Â  });
Â Â 
Â  // Consult Modal
Â  document.getElementById('schedule-call-btn').addEventListener('click', () => {
Â  Â  // In a real app, this would redirect to a scheduling link (e.g., Calendly)
Â  Â  showToast('Redirecting to scheduling page...', 'success');
Â  Â  window.open('https://example.com/schedule-consultation', '_blank');
Â  Â  closeAllModals();
Â  });

Â  // Import Logic
Â  document.getElementById('import-input').addEventListener('change', (e) => {
Â  Â  const file = e.target.files[0];
Â  Â  if (!file) return;

Â  Â  const reader = new FileReader();
Â  Â  reader.onload = (event) => {
Â  Â  Â  try {
Â  Â  Â  Â  const importedData = JSON.parse(event.target.result);
Â  Â  Â  Â  if (importedData && importedData.title && importedData.steps) {
Â  Â  Â  Â  Â  // Assign a new ID to prevent overwriting
Â  Â  Â  Â  Â  importedData.id = generateId(); 
Â  Â  Â  Â  Â  allSOPs[importedData.id] = importedData;
Â  Â  Â  Â  Â  loadSOP(importedData.id);
Â  Â  Â  Â  Â  showToast(`SOP "${importedData.title}" imported successfully!`);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  throw new Error("Invalid SOP format");
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showToast('Error importing file: Invalid JSON or format.', 'error');
Â  Â  Â  }
Â  Â  };
Â  Â  reader.readAsText(file);
Â  });
});
</script>
</body>
</html>
