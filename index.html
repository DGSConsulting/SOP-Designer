<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workflow Prototype</title>
<style>
  body {
    margin: 0; font-family: sans-serif; background: #f4f4f4; overflow: hidden;
  }
  #toolbar {
    position: fixed; top: 0; left: 0; width: 100%; padding: 10px;
    background: #fff; border-bottom: 1px solid #ccc; z-index: 1000;
  }
  #canvas {
    position: relative; width: 100vw; height: 100vh; overflow: auto;
  }
  .step-card {
    position: absolute; width: 180px; background: #fff; border: 1px solid #ccc;
    border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: grab;
  }
  .step-card h3 { margin: 0 0 10px 0; font-size: 16px; }
  .branches { margin-top: 5px; }
  .branch {
    display: flex; align-items: center; margin: 5px 0;
  }
  .branch input { flex: 1; font-size: 14px; padding: 3px; }
  .branch select { margin-left: 5px; font-size: 14px; }
  button { margin-left: 5px; }
  svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
  line { stroke: #888; stroke-width: 2; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="undo()">Undo</button>
  <button onclick="redo()">Redo</button>
</div>

<div id="canvas">
  <svg id="connections"></svg>

  <div class="step-card" id="step1" style="left: 50px; top: 50px;">
    <h3>Start</h3>
    <div class="branches">
      <div class="branch">
        <input value="Approve" class="branch-label">
        <select class="branch-target">
          <option value="step2">Step 2</option>
          <option value="step3">Step 3</option>
        </select>
      </div>
      <div class="branch">
        <input value="Reject" class="branch-label">
        <select class="branch-target">
          <option value="step2">Step 2</option>
          <option value="step3">Step 3</option>
        </select>
      </div>
    </div>
  </div>

  <div class="step-card" id="step2" style="left: 300px; top: 50px;">
    <h3>Step 2</h3>
    <div class="branches"></div>
  </div>

  <div class="step-card" id="step3" style="left: 300px; top: 200px;">
    <h3>Step 3</h3>
    <div class="branches"></div>
  </div>

</div>

<script>
const canvas = document.getElementById('canvas');
const connections = document.getElementById('connections');

let undoStack = [], redoStack = [];

function getWorkflowState() {
  const steps = Array.from(document.querySelectorAll('.step-card')).map(card => ({
    id: card.id,
    left: parseFloat(card.style.left),
    top: parseFloat(card.style.top),
    branches: Array.from(card.querySelectorAll('.branch')).map(b => ({
      label: b.querySelector('.branch-label').value,
      target: b.querySelector('.branch-target').value
    }))
  }));
  return { steps };
}

function loadWorkflowState(state) {
  state.steps.forEach(s => {
    const card = document.getElementById(s.id);
    if (!card) return;
    card.style.left = s.left + 'px';
    card.style.top = s.top + 'px';
    const branchElements = card.querySelectorAll('.branch');
    s.branches.forEach((b, i) => {
      if (branchElements[i]) {
        branchElements[i].querySelector('.branch-label').value = b.label;
        branchElements[i].querySelector('.branch-target').value = b.target;
      }
    });
  });
  drawConnections();
}

function saveState() {
  undoStack.push(JSON.stringify(getWorkflowState()));
  redoStack = [];
}

function undo() {
  if (!undoStack.length) return;
  redoStack.push(JSON.stringify(getWorkflowState()));
  const state = JSON.parse(undoStack.pop());
  loadWorkflowState(state);
}

function redo() {
  if (!redoStack.length) return;
  undoStack.push(JSON.stringify(getWorkflowState()));
  const state = JSON.parse(redoStack.pop());
  loadWorkflowState(state);
}

function drawConnections() {
  connections.innerHTML = '';
  document.querySelectorAll('.step-card').forEach(card => {
    const rect = card.getBoundingClientRect();
    const cardX = rect.left + rect.width / 2 + window.scrollX;
    const cardY = rect.top + rect.height / 2 + window.scrollY;

    card.querySelectorAll('.branch').forEach(branch => {
      const targetId = branch.querySelector('.branch-target').value;
      const targetCard = document.getElementById(targetId);
      if (!targetCard) return;
      const targetRect = targetCard.getBoundingClientRect();
      const targetX = targetRect.left + targetRect.width / 2 + window.scrollX;
      const targetY = targetRect.top + targetRect.height / 2 + window.scrollY;

      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', cardX);
      line.setAttribute('y1', cardY);
      line.setAttribute('x2', targetX);
      line.setAttribute('y2', targetY);
      connections.appendChild(line);
    });
  });
}

// Dragging
let selectedCard = null;
let offsetX = 0, offsetY = 0;

canvas.addEventListener('mousedown', e => {
  if (!e.target.closest('.step-card')) return;
  selectedCard = e.target.closest('.step-card');
  offsetX = e.clientX - selectedCard.getBoundingClientRect().left;
  offsetY = e.clientY - selectedCard.getBoundingClientRect().top;
  saveState();
});

canvas.addEventListener('mousemove', e => {
  if (!selectedCard) return;
  selectedCard.style.left = e.clientX - offsetX + 'px';
  selectedCard.style.top = e.clientY - offsetY + 'px';
  drawConnections();
});

canvas.addEventListener('mouseup', e => {
  if (selectedCard) {
    drawConnections();
    selectedCard = null;
  }
});

// Branch updates
document.querySelectorAll('.branch-label, .branch-target').forEach(input => {
  input.addEventListener('input', () => {
    saveState();
    drawConnections();
  });
});

drawConnections();
saveState();
</script>

</body>
</html>
