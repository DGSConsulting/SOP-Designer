<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOP Prototype</title>
<style>
  body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; }
  #editor { width: 40%; padding: 10px; overflow-y: auto; border-right: 1px solid #ccc; }
  #diagram { width: 60%; padding: 10px; overflow: auto; background: #f7f7f7; }
  .step-card { background: #fff; margin: 5px 0; padding: 8px; border: 1px solid #ddd; cursor: grab; }
  .branch { margin-left: 20px; padding-left: 10px; border-left: 2px dashed #aaa; }
  button { margin: 5px; }
</style>
</head>
<body>

<div id="editor">
  <h2>Steps</h2>
  <button onclick="addStep()">Add Step</button>
  <button onclick="undo()">Undo</button>
  <button onclick="redo()">Redo</button>
  <div id="steps"></div>
  <h3>Templates</h3>
  <button onclick="loadTemplate('onboarding')">Client Onboarding</button>
</div>

<div id="diagram">
  <h2>Diagram</h2>
  <svg id="svgDiagram" width="100%" height="100%"></svg>
</div>

<script>
// --- Data ---
let steps = [];
let history = [];
let redoStack = [];

// --- Templates ---
const templates = {
  onboarding: [
    { text: "Receive client info", branches: [] },
    { text: "Setup project folder", branches: [] },
    { text: "Send welcome email", branches: [] }
  ]
};

// --- Functions ---
function saveHistory() {
  history.push(JSON.stringify(steps));
  if(history.length>50) history.shift(); // limit stack size
}

function undo() {
  if(history.length>1) {
    redoStack.push(history.pop());
    steps = JSON.parse(history[history.length-1]);
    renderSteps();
    renderDiagram();
  }
}

function redo() {
  if(redoStack.length) {
    steps = JSON.parse(redoStack.pop());
    history.push(JSON.stringify(steps));
    renderSteps();
    renderDiagram();
  }
}

function addStep(text="New Step") {
  steps.push({ text, branches: [] });
  saveHistory();
  renderSteps();
  renderDiagram();
}

function addBranch(step) {
  const branchText = prompt("Branch step text:");
  if(branchText) step.branches.push({ text: branchText, branches: [] });
  saveHistory();
  renderSteps();
  renderDiagram();
}

function renderSteps() {
  const container = document.getElementById('steps');
  container.innerHTML = '';
  steps.forEach((step, idx) => {
    const div = document.createElement('div');
    div.className = 'step-card';
    div.innerHTML = `<input value="${step.text}" onchange="updateStep(${idx}, this.value)"/>
                     <button onclick="addBranch(steps[${idx}])">Add Branch</button>`;
    if(step.branches.length) {
      step.branches.forEach((b,i)=>{
        const branchDiv = document.createElement('div');
        branchDiv.className = 'step-card branch';
        branchDiv.innerHTML = `<input value="${b.text}" onchange="updateBranch(${idx},${i},this.value)"/>`;
        div.appendChild(branchDiv);
      });
    }
    container.appendChild(div);
  });
}

function updateStep(idx, value) { steps[idx].text = value; saveHistory(); renderDiagram(); }
function updateBranch(idx, bIdx, value) { steps[idx].branches[bIdx].text = value; saveHistory(); renderDiagram(); }

function loadTemplate(name) {
  steps = JSON.parse(JSON.stringify(templates[name]));
  saveHistory();
  renderSteps();
  renderDiagram();
}

// --- Diagram rendering ---
function renderDiagram() {
  const svg = document.getElementById('svgDiagram');
  svg.innerHTML = '';
  let y = 20;
  const drawStep = (step, level=0, parentX=100, parentY=0) => {
    const x = 50 + level*150;
    svg.innerHTML += `<rect x="${x}" y="${y}" width="120" height="40" fill="#4CAF50" rx="5" ry="5"></rect>`;
    svg.innerHTML += `<text x="${x+60}" y="${y+25}" text-anchor="middle" fill="#fff">${step.text}</text>`;
    if(parentY) svg.innerHTML += `<line x1="${parentX+60}" y1="${parentY+40}" x2="${x+60}" y2="${y}" stroke="#000"/>`;
    let currentY = y;
    y += 60;
    step.branches.forEach(b => drawStep(b, level+1, x, currentY));
  };
  steps.forEach(s => drawStep(s));
}

// --- Init ---
addStep();
</script>
</body>
</html>
