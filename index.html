<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOP Manager - DGS Consulting</title>
<style>
  * { box-sizing: border-box; }
  
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
    margin: 0; 
    height: 100vh;
    background: #f5f5f5;
    display: flex;
  }
  
  #sidebar {
    width: 280px;
    background: #2c3e50;
    color: white;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #1a252f;
    overflow-y: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 100;
  }
  
  #sidebar.mobile-hidden {
    transform: translateX(-100%);
    position: absolute;
    height: 100%;
  }
  
  .sidebar-header {
    padding: 18px 16px;
    border-bottom: 1px solid #34495e;
    background: #1a252f;
    flex-shrink: 0;
  }
  
  .sidebar-header h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #4CAF50;
  }
  
  .sidebar-content {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    min-height: 0;
  }
  
  .sop-item {
    padding: 10px;
    margin: 6px 0;
    background: rgba(255,255,255,0.08);
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    border: 2px solid transparent;
    transition: all 0.2s;
  }
  
  .sop-item:hover {
    background: rgba(255,255,255,0.12);
    border-color: #4CAF50;
  }
  
  .sop-item.active {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.2);
  }
  
  .sop-item-name {
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .sop-item-meta {
    font-size: 11px;
    color: rgba(255,255,255,0.6);
    margin-top: 4px;
  }
  
  .sop-item-actions {
    margin-top: 6px;
    display: flex;
    gap: 4px;
  }
  
  .sop-item-actions button {
    padding: 3px 6px;
    background: rgba(255,255,255,0.15);
    color: white;
    border: none;
    border-radius: 2px;
    cursor: pointer;
    font-size: 11px;
    transition: background 0.2s;
  }
  
  .sop-item-actions button:hover {
    background: rgba(255,255,255,0.25);
  }
  
  .sidebar-footer {
    padding: 12px;
    border-top: 1px solid #34495e;
    flex-shrink: 0;
  }
  
  .new-sop-btn {
    width: 100%;
    padding: 10px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: background 0.2s;
  }
  
  .new-sop-btn:hover {
    background: #45a049;
  }
  
  .search-box {
    padding: 0 12px 12px;
    flex-shrink: 0;
  }
  
  .search-box input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 4px;
    font-size: 12px;
    background: rgba(0,0,0,0.2);
    color: white;
  }
  
  .search-box input::placeholder {
    color: rgba(255,255,255,0.5);
  }
  
  .sidebar-actions {
    padding: 12px;
    border-top: 1px solid #34495e;
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex-shrink: 0;
  }
  
  .sidebar-actions button {
    padding: 6px;
    font-size: 11px;
    background: rgba(255,255,255,0.15);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .sidebar-actions button:hover {
    background: rgba(255,255,255,0.25);
  }
  
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }
  
  .top-bar {
    display: none;
    padding: 8px 12px;
    background: #2c3e50;
    color: white;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  
  .toggle-sidebar-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
  }
  
  #editor {
    display: flex;
    flex: 1;
    overflow: hidden;
    min-height: 0;
  }
  
  .editor-left {
    width: 45%;
    padding: 20px;
    overflow-y: auto;
    border-right: 1px solid #ddd;
    background: white;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }
  
  .editor-right {
    width: 55%;
    padding: 20px;
    overflow: auto;
    background: #f9f9f9;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }
  
  h1 { 
    font-size: 24px; 
    color: #333; 
    margin: 0 0 12px 0;
    font-weight: 600;
  }
  h2 { 
    font-size: 16px; 
    color: #555; 
    margin: 0 0 12px 0;
    font-weight: 600;
  }
  h3 { 
    font-size: 12px; 
    color: #666; 
    margin: 0 0 8px 0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .sop-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #eee;
    flex-shrink: 0;
  }
  
  .sop-name-input {
    flex: 1;
    font-size: 16px;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .sop-name-input:focus {
    outline: none;
    border-color: #4CAF50;
  }
  
  .rename-btn {
    padding: 6px 10px;
    font-size: 12px;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .rename-btn:hover {
    background: #0b7dda;
  }
  
  .toolbar {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
    flex-wrap: wrap;
    flex-shrink: 0;
  }
  
  button {
    padding: 8px 12px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: background 0.2s;
  }
  
  button:hover { background: #45a049; }
  button:active { opacity: 0.8; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  
  .secondary {
    background: #2196F3;
  }
  .secondary:hover { background: #0b7dda; }
  
  .tertiary {
    background: #666;
  }
  .tertiary:hover { background: #555; }
  
  .danger {
    background: #f44336;
  }
  .danger:hover { background: #da190b; }
  
  .steps-list {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 12px;
    padding-right: 8px;
    min-height: 0;
  }
  
  .steps-list::-webkit-scrollbar {
    width: 6px;
  }
  
  .steps-list::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  
  .steps-list::-webkit-scrollbar-thumb {
    background: #ddd;
    border-radius: 3px;
  }
  
  .step-card {
    background: white;
    margin: 8px 0;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: grab;
    transition: all 0.2s;
  }
  
  .step-card:hover {
    border-color: #4CAF50;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  
  .step-card.dragging {
    opacity: 0.5;
    background: #f0f0f0;
  }
  
  .step-number {
    display: inline-block;
    background: #4CAF50;
    color: white;
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    font-size: 10px;
    font-weight: 600;
    margin-right: 6px;
    flex-shrink: 0;
  }
  
  .step-input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 12px;
    font-family: inherit;
    margin: 6px 0;
  }
  
  .step-input:focus {
    outline: none;
    border-color: #4CAF50;
  }
  
  .step-controls {
    display: flex;
    gap: 4px;
    margin-top: 8px;
    flex-wrap: wrap;
  }
  
  .step-controls button {
    padding: 4px 8px;
    font-size: 11px;
  }
  
  .branch {
    margin-left: 18px;
    margin-top: 8px;
    padding: 10px;
    background: #f0f7ff;
    border-left: 3px solid #2196F3;
    border-radius: 3px;
  }
  
  .branch::before {
    content: "‚Ü≥";
    position: absolute;
    left: -16px;
    color: #2196F3;
  }
  
  .section {
    margin-top: 12px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 4px;
    border-left: 3px solid #4CAF50;
    flex-shrink: 0;
  }
  
  select, input[type="number"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 12px;
    margin-bottom: 6px;
  }
  
  select:focus, input:focus {
    outline: none;
    border-color: #4CAF50;
  }
  
  .template-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }
  
  .template-btn {
    padding: 8px;
    font-size: 11px;
    background: #FF9800;
    text-align: center;
  }
  
  .template-btn:hover { background: #e68900; }
  
  .tags-input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 12px;
    margin-bottom: 6px;
  }
  
  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  
  .tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    border: 1px solid #90caf9;
  }
  
  .tag .remove {
    margin-left: 6px;
    cursor: pointer;
  }
  
  #svgDiagram {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    flex: 1;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    min-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .status-badge {
    display: inline-block;
    padding: 2px 8px;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
  }
  
  .warning-banner {
    padding: 10px 12px;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    color: #856404;
    font-size: 11px;
    margin-bottom: 12px;
    display: none;
    flex-shrink: 0;
  }
  
  .warning-banner.show {
    display: block;
  }
  
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  
  .modal.active { display: flex; }
  
  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 6px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .modal-content h2 { 
    margin-top: 0; 
    font-size: 16px;
    margin-bottom: 12px;
  }
  
  .share-link {
    padding: 10px;
    background: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 10px;
    word-break: break-all;
    margin: 10px 0;
    user-select: all;
    max-height: 70px;
    overflow-y: auto;
  }
  
  .version-item {
    padding: 10px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 3px;
    margin: 6px 0;
    font-size: 11px;
  }
  
  .version-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  
  .comment {
    padding: 8px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 3px;
    margin: 6px 0;
    font-size: 11px;
  }
  
  .footer {
    padding: 10px 14px;
    background: #2c3e50;
    color: rgba(255,255,255,0.7);
    font-size: 10px;
    border-top: 1px solid #1a252f;
    flex-shrink: 0;
  }
  
  .footer-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .footer-branding strong {
    color: white;
    font-size: 11px;
    display: block;
  }
  
  .footer-contact {
    display: flex;
    gap: 12px;
  }
  
  .footer-link {
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    font-size: 10px;
  }
  
  .footer-link:hover {
    color: white;
  }
  
  .trash-section {
    margin-top: 12px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 4px;
    border-left: 3px solid #f44336;
    flex-shrink: 0;
  }
  
  .empty-state {
    text-align: center;
    padding: 30px 20px;
    color: #999;
  }
  
  @media (max-width: 768px) {
    body { flex-direction: column; }
    #sidebar { width: 100%; height: auto; flex-direction: row; position: static; }
    #sidebar.mobile-hidden { transform: translateX(-100%); }
    .top-bar { display: flex; }
    .sidebar-content { display: none; }
    .sidebar-content.mobile-show { display: block; }
    #editor { flex-direction: column; }
    .editor-left { width: 100%; height: 50%; border-right: none; border-bottom: 1px solid #ddd; }
    .editor-right { width: 100%; height: 50%; }
    .template-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="sidebar-header">
    <h1>SOP Manager</h1>
  </div>
  
  <div class="search-box">
    <input type="text" id="searchBox" placeholder="Search..." onkeyup="searchSOPs()" aria-label="Search SOPs">
  </div>
  
  <div class="sidebar-content" id="sopList"></div>
  
  <div class="sidebar-actions">
    <button onclick="exportAllSOPs()">Backup All</button>
    <button onclick="importSOPs()" class="secondary">Restore</button>
  </div>
  
  <div class="sidebar-footer">
    <button class="new-sop-btn" onclick="createNewSOP()">+ New SOP</button>
  </div>
</div>

<!-- Mobile Top Bar -->
<div class="top-bar">
  <button class="toggle-sidebar-btn" onclick="toggleSidebar()">‚ò∞</button>
  <span id="mobileTitle">SOP Manager</span>
</div>

<!-- Main Editor -->
<div id="main">
  <div id="editor">
    <!-- Left Panel -->
    <div class="editor-left">
      <div class="warning-banner" id="warningBanner">
        You have unsaved changes. They will auto-save when you switch SOPs.
      </div>
      
      <div class="sop-header">
        <div style="flex: 1;">
          <h1 id="sopTitle">Untitled SOP</h1>
          <span class="status-badge" id="sopStatus">DRAFT</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-shrink: 0;">
        <input type="text" id="sopNameInput" class="sop-name-input" placeholder="Enter SOP Name" onchange="updateSOPName()">
        <button class="rename-btn" onclick="renameSOPQuick()">Edit</button>
      </div>
      
      <div class="toolbar">
        <button onclick="addStep()">+ Step</button>
        <button onclick="undo()" id="undoBtn" disabled>Undo</button>
        <button onclick="redo()" id="redoBtn" disabled>Redo</button>
        <button class="secondary" onclick="openShareModal()">Share</button>
        <button class="secondary" onclick="exportOptions()">Export</button>
      </div>
      
      <div class="steps-list" id="stepsList"></div>
      
      <!-- Ownership -->
      <div class="section">
        <h3>Ownership</h3>
        <input type="text" id="ownerInput" placeholder="Owner name" onchange="updateSOPOwner(this.value)">
        <div style="font-size: 10px; color: #666; margin-top: 4px;" id="ownerDisplay"></div>
      </div>

      <!-- Last Reviewed -->
      <div class="section">
        <h3>Review</h3>
        <button onclick="markReviewedNow()" style="width: 100%; background: #4CAF50; margin-bottom: 6px; padding: 8px;">Mark Reviewed Today</button>
        <div style="font-size: 10px; color: #666; line-height: 1.4;" id="reviewDisplay">Never reviewed</div>
      </div>

      <!-- Created Info -->
      <div class="section">
        <h3>Created</h3>
        <div style="font-size: 10px; color: #666; line-height: 1.4;">
          <div id="createdDisplay"></div>
        </div>
      </div>
      
      <!-- Status -->
      <div class="section">
        <h3>Status</h3>
        <select id="statusSelect" onchange="updateSOPStatus(this.value)">
          <option value="DRAFT">Draft</option>
          <option value="ACTIVE">Active</option>
          <option value="REVIEW">Under Review</option>
          <option value="ARCHIVED">Archived</option>
        </select>
      </div>

      <!-- Category -->
      <div class="section">
        <h3>Category</h3>
        <select id="categorySelect" onchange="updateSOPCategory(this.value)">
          <option value="General">General</option>
          <option value="Sales">Sales</option>
          <option value="HR">HR</option>
          <option value="Operations">Operations</option>
          <option value="Support">Support</option>
        </select>
      </div>

      <!-- Time Estimate -->
      <div class="section">
        <h3>Time Estimate</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="number" id="totalTimeInput" min="0" placeholder="minutes" onchange="updateTotalTime(this.value)">
          <span style="font-size: 11px; color: #666; white-space: nowrap;" id="timeDisplay">No estimate</span>
        </div>
        <div style="margin-top: 8px; font-size: 10px; color: #666;" id="stepTimesDisplay"></div>
      </div>
      
      <!-- Tags -->
      <div class="section">
        <h3>Tags</h3>
        <input type="text" class="tags-input" id="tagsInput" placeholder="comma-separated" onchange="updateTags()">
        <div class="tags-list" id="tagsList"></div>
      </div>

      <!-- Activity & History -->
      <div class="section">
        <h3>History</h3>
        <button onclick="viewChangeLog()" style="width: 100%; margin-bottom: 6px;">View Changes</button>
        <button onclick="viewAuditTrail()" style="width: 100%; background: #2196F3;">View Activity</button>
      </div>

      <!-- Analytics -->
      <div class="section">
        <h3>Analytics</h3>
        <button onclick="viewSOPAnalytics()" style="width: 100%; margin-bottom: 6px; background: #FF9800;">View Stats</button>
        <button onclick="viewDashboard()" style="width: 100%; background: #2196F3;">Dashboard</button>
      </div>
      
      <!-- Templates -->
      <div class="section">
        <h3>Templates</h3>
        <div class="template-grid">
          <button class="template-btn" onclick="loadTemplate('onboarding')">Onboarding</button>
          <button class="template-btn" onclick="loadTemplate('invoicing')">Invoicing</button>
          <button class="template-btn" onclick="loadTemplate('qa')">QA</button>
        </div>
      </div>

      <!-- Trash -->
      <div class="trash-section">
        <h3>Trash</h3>
        <button onclick="viewTrash()" style="width: 100%; background: #f44336;">View Deleted</button>
      </div>
    </div>
    
    <!-- Right Panel -->
    <div class="editor-right">
      <h2>Flow Diagram</h2>
      <svg id="svgDiagram" width="100%" height="100%"></svg>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="exportModal" class="modal">
  <div class="modal-content">
    <h2>Export SOP</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
      <button onclick="exportPDF()" class="secondary">PDF</button>
      <button onclick="exportHTML()" class="secondary">HTML</button>
      <button onclick="exportCSV()" class="secondary">CSV</button>
      <button onclick="exportDiagramImage()" class="secondary">Diagram</button>
    </div>
    <button class="tertiary" onclick="closeExportModal()" style="margin-top: 10px; width: 100%;">Close</button>
  </div>
</div>

<div id="shareModal" class="modal">
  <div class="modal-content">
    <h2>Share SOP</h2>
    <p style="font-size: 12px;">Read-only link:</p>
    <div class="share-link" id="shareLink"></div>
    <button onclick="copyToClipboard()" class="secondary">Copy Link</button>
    <button class="tertiary" onclick="closeShareModal()">Close</button>
  </div>
</div>

<div id="versionsModal" class="modal">
  <div class="modal-content">
    <h2>Version History</h2>
    <div id="versionsList" style="max-height: 350px; overflow-y: auto;"></div>
    <button class="tertiary" onclick="closeVersionsModal()" style="margin-top: 10px; width: 100%;">Close</button>
  </div>
</div>

<div id="commentModal" class="modal">
  <div class="modal-content">
    <h2>Comments</h2>
    <div style="margin-bottom: 12px;">
      <input type="text" id="commentAuthorInput" placeholder="Your name" style="width: 100%; margin-bottom: 6px;">
      <input type="text" id="commentTextInput" placeholder="Add comment..." style="width: 100%; margin-bottom: 6px;" onkeypress="if(event.key==='Enter') addComment()">
      <button onclick="addComment()" class="secondary" style="width: 100%;">Post</button>
    </div>
    <div id="commentsList" style="max-height: 250px; overflow-y: auto;"></div>
    <button class="tertiary" onclick="closeCommentModal()" style="margin-top: 10px; width: 100%;">Close</button>
  </div>
</div>

<div id="auditModal" class="modal">
  <div class="modal-content">
    <h2>Activity Log</h2>
    <div style="margin-bottom: 10px; font-size: 11px;">
      <input type="text" id="auditFilterInput" placeholder="Filter by action..." onkeyup="filterAuditTrail()" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px;">
    </div>
    <div id="auditTrailList" style="max-height: 350px; overflow-y: auto;"></div>
    <button class="tertiary" onclick="closeAuditModal()" style="margin-top: 10px; width: 100%;">Close</button>
  </div>
</div>

<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <h2>SOP Statistics</h2>
    <div id="analyticsContent" style="font-size: 11px; max-height: 400px; overflow-y: auto;"></div>
    <button class="tertiary" onclick="closeAnalyticsModal()" style="margin-top: 10px; width: 100%;">Close</button>
  </div>
</div>

<div id="dashboardModal" class="modal">
  <div class="modal-content">
    <h2>Compliance Dashboard</h2>
    <div id="dashboardContent" style="font-size: 11px; max-height: 400px; overflow-y: auto;"></div>
    <button class="tertiary" onclick="closeDashboardModal()" style="margin-top: 10px; width: 100%;">Close</button>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  <div class="footer-content">
    <div class="footer-branding">
      <strong>DGS Consulting Solutions</strong>
      <div>DGSConsult@consultant.com ‚Ä¢ 1 (289) 222-0511</div>
    </div>
    <div class="footer-contact">
      <a href="mailto:DGSConsult@consultant.com" class="footer-link">Email</a>
      <a href="tel:+12892220511" class="footer-link">Call</a>
      <a href="https://dgsconsulting.solutions/" class="footer-link" target="_blank">Website</a>
    </div>
  </div>
</footer>

<script>
// ============ STATE ============
let allSOPs = {};
let trash = {};
let currentSOPId = null;
let steps = [];
let history = [];
let redoStack = [];
let versions = [];
let comments = [];
let tags = [];
let hasUnsavedChanges = false;
let isMobile = window.innerWidth <= 768;

let sopStatus = 'DRAFT';
let sopCategory = 'General';
let totalTimeEstimate = 0;
let currentCategoryFilter = 'General';

// ============ TEMPLATES ============
const templates = {
  onboarding: [
    { text: "Receive client intake form", branches: [], duration: 10 },
    { text: "Review requirements and scope", branches: [], duration: 15 },
    { text: "Create client folder in shared drive", branches: [], duration: 5 },
    { text: "Set up email account/distribution list", branches: [], duration: 10 },
    { text: "Create client in CRM system", branches: [], duration: 10 },
    { text: "Prepare welcome packet", branches: [], duration: 15 },
    { text: "Send welcome email with credentials", branches: [], duration: 5 },
    { text: "Schedule kickoff meeting", branches: [
      { text: "Coordinate calendar availability", branches: [], duration: 10 },
      { text: "Send meeting invite with agenda", branches: [], duration: 5 }
    ], duration: 10 },
    { text: "Conduct kickoff call", branches: [
      { text: "Introduce team members", branches: [], duration: 5 },
      { text: "Review project timeline", branches: [], duration: 10 },
      { text: "Confirm communication preferences", branches: [], duration: 5 }
    ], duration: 20 },
    { text: "Add to project management tool", branches: [], duration: 10 },
    { text: "Send kickoff summary and next steps", branches: [], duration: 10 }
  ],
  invoicing: [
    { text: "Gather time tracking data from team", branches: [
      { text: "Send timesheet reminder", branches: [], duration: 5 },
      { text: "Collect individual timesheets", branches: [], duration: 20 },
      { text: "Verify all hours are logged", branches: [], duration: 10 }
    ], duration: 20 },
    { text: "Compile expense reports", branches: [
      { text: "Collect receipts from team", branches: [], duration: 15 },
      { text: "Verify all expenses are approved", branches: [], duration: 15 },
      { text: "Reconcile with accounting system", branches: [], duration: 10 }
    ], duration: 30 },
    { text: "Calculate billable hours by project", branches: [], duration: 15 },
    { text: "Apply rate structure and discounts", branches: [
      { text: "Check contract pricing", branches: [], duration: 10 },
      { text: "Apply any agreed discounts", branches: [], duration: 5 }
    ], duration: 15 },
    { text: "Generate invoice from template", branches: [], duration: 10 },
    { text: "Add invoice to invoice tracking sheet", branches: [], duration: 5 },
    { text: "Review invoice for accuracy and completeness", branches: [
      { text: "Check all line items", branches: [], duration: 5 },
      { text: "Verify totals and taxes", branches: [], duration: 5 },
      { text: "Confirm client billing address", branches: [], duration: 3 }
    ], duration: 15 },
    { text: "Get manager approval if needed", branches: [], duration: 10 },
    { text: "Send invoice to client", branches: [], duration: 5 },
    { text: "Log invoice in accounting system", branches: [], duration: 10 },
    { text: "Set follow-up reminder for payment", branches: [], duration: 5 }
  ],
  qa: [
    { text: "Pull latest code from main branch", branches: [], duration: 5 },
    { text: "Review code changes and release notes", branches: [], duration: 15 },
    { text: "Set up fresh test environment", branches: [], duration: 10 },
    { text: "Run full automated test suite", branches: [
      { text: "Run unit tests", branches: [], duration: 15 },
      { text: "Run integration tests", branches: [], duration: 20 },
      { text: "If tests fail: log bugs and notify developers", branches: [], duration: 30 }
    ], duration: 30 },
    { text: "Manual smoke testing on staging", branches: [
      { text: "Test critical user flows", branches: [], duration: 20 },
      { text: "Test authentication and permissions", branches: [], duration: 15 },
      { text: "Check UI/UX consistency", branches: [], duration: 10 },
      { text: "Log any issues found", branches: [], duration: 10 }
    ], duration: 40 },
    { text: "Performance baseline check", branches: [
      { text: "Run load testing", branches: [], duration: 15 },
      { text: "Compare to previous baseline", branches: [], duration: 10 },
      { text: "Flag regressions if found", branches: [], duration: 10 }
    ], duration: 20 },
    { text: "Security testing", branches: [
      { text: "Run security scan tools", branches: [], duration: 15 },
      { text: "Test for common vulnerabilities", branches: [], duration: 20 }
    ], duration: 25 },
    { text: "Create QA sign-off report", branches: [], duration: 15 },
    { text: "If all tests pass: approve deployment", branches: [], duration: 5 },
    { text: "If issues found: notify developers and schedule re-test", branches: [], duration: 10 }
  ],
  projectHandoff: [
    { text: "Prepare project completion summary", branches: [], duration: 20 },
    { text: "Compile all project deliverables", branches: [
      { text: "Gather documents and assets", branches: [], duration: 15 },
      { text: "Organize in shared folder", branches: [], duration: 10 },
      { text: "Create index/guide", branches: [], duration: 10 }
    ], duration: 25 },
    { text: "Document system access and credentials", branches: [
      { text: "List all tools and platforms used", branches: [], duration: 10 },
      { text: "Document login procedures", branches: [], duration: 10 },
      { text: "Securely transfer credentials to client", branches: [], duration: 5 }
    ], duration: 20 },
    { text: "Prepare training materials", branches: [
      { text: "Create documentation", branches: [], duration: 30 },
      { text: "Record video tutorials if needed", branches: [], duration: 45 },
      { text: "Prepare FAQ document", branches: [], duration: 20 }
    ], duration: 60 },
    { text: "Conduct training session with client team", branches: [
      { text: "Walk through system/deliverables", branches: [], duration: 45 },
      { text: "Answer questions", branches: [], duration: 30 },
      { text: "Record session for reference", branches: [], duration: 10 }
    ], duration: 60 },
    { text: "Create ongoing support plan", branches: [
      { text: "Define support hours", branches: [], duration: 10 },
      { text: "List escalation procedures", branches: [], duration: 10 },
      { text: "Document SLA if applicable", branches: [], duration: 10 }
    ], duration: 20 },
    { text: "Conduct final project review meeting", branches: [
      { text: "Review accomplishments vs. goals", branches: [], duration: 15 },
      { text: "Discuss lessons learned", branches: [], duration: 15 },
      { text: "Gather feedback from client", branches: [], duration: 15 }
    ], duration: 30 },
    { text: "Close out project in tracking system", branches: [], duration: 10 },
    { text: "Archive project files", branches: [], duration: 15 },
    { text: "Send project completion report to client", branches: [], duration: 10 }
  ],
  meetingPrep: [
    { text: "Review meeting objective and agenda", branches: [], duration: 10 },
    { text: "Prepare presentation materials", branches: [
      { text: "Create slides if needed", branches: [], duration: 45 },
      { text: "Gather data and reports", branches: [], duration: 20 },
      { text: "Prepare talking points", branches: [], duration: 15 }
    ], duration: 45 },
    { text: "Review attendee list and background", branches: [], duration: 15 },
    { text: "Send meeting invite with agenda and materials", branches: [], duration: 10 },
    { text: "Prepare meeting space or Zoom link", branches: [
      { text: "Test video/audio", branches: [], duration: 10 },
      { text: "Prepare screen sharing", branches: [], duration: 5 }
    ], duration: 10 },
    { text: "Arrive 10 minutes early", branches: [], duration: 0 },
    { text: "Conduct meeting", branches: [
      { text: "Review agenda", branches: [], duration: 5 },
      { text: "Present materials", branches: [], duration: 45 },
      { text: "Allow Q&A time", branches: [], duration: 20 }
    ], duration: 60 },
    { text: "Document action items and decisions", branches: [], duration: 10 },
    { text: "Send follow-up email with minutes", branches: [
      { text: "List decisions made", branches: [], duration: 10 },
      { text: "List action items with owners", branches: [], duration: 10 },
      { text: "Schedule next meeting if needed", branches: [], duration: 5 }
    ], duration: 15 }
  ]
};


// ============ KEYBOARD SHORTCUTS ============
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'z' && !e.shiftKey) {
      e.preventDefault();
      undo();
    } else if (e.key === 'y' || (e.shiftKey && e.key === 'z')) {
      e.preventDefault();
      redo();
    } else if (e.key === 'n') {
      e.preventDefault();
      addStep();
    }
  }
}, false);

// ============ UNSAVED CHANGES ============
function markUnsaved() {
  hasUnsavedChanges = true;
  document.getElementById('warningBanner').classList.add('show');
}

function markSaved() {
  hasUnsavedChanges = false;
  document.getElementById('warningBanner').classList.remove('show');
}

window.addEventListener('beforeunload', (e) => {
  if (hasUnsavedChanges && currentSOPId && steps.length > 0) {
    e.preventDefault();
    e.returnValue = '';
  }
  if (currentSOPId && steps.length > 0) {
    allSOPs[currentSOPId].steps = steps;
    allSOPs[currentSOPId].tags = tags;
    allSOPs[currentSOPId].comments = comments;
    saveToStorage();
  }
});

// ============ MOBILE SUPPORT ============
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('mobile-hidden');
  document.getElementById('sopList').parentElement.classList.toggle('mobile-show');
}

window.addEventListener('resize', () => {
  isMobile = window.innerWidth <= 768;
});

// ============ SOP MANAGEMENT ============
function createNewSOP() {
  const name = prompt("Enter SOP name:", "My New SOP");
  if (!name || !name.trim()) return;
  
  const id = 'sop-' + Date.now();
  allSOPs[id] = {
    id,
    name: name.trim(),
    steps: [{ text: "Step 1", branches: [], duration: 0 }],
    tags: [],
    comments: [],
    versions: [],
    status: 'DRAFT',
    category: 'General',
    totalTime: 0,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  loadSOP(id);
  saveToStorage();
}

function loadSOP(id) {
  if (!allSOPs[id]) return;
  
  if (hasUnsavedChanges && currentSOPId) {
    allSOPs[currentSOPId].steps = steps;
    allSOPs[currentSOPId].tags = tags;
    allSOPs[currentSOPId].comments = comments;
    saveToStorage();
  }
  
  currentSOPId = id;
  const sop = allSOPs[id];
  
  steps = JSON.parse(JSON.stringify(sop.steps));
  comments = JSON.parse(JSON.stringify(sop.comments || []));
  tags = [...(sop.tags || [])];
  versions = [...(sop.versions || [])];
  
  sopStatus = sop.status || 'DRAFT';
  sopCategory = sop.category || 'General';
  totalTimeEstimate = sop.totalTime || 0;
  
  history = [JSON.stringify(steps)];
  redoStack = [];
  
  document.getElementById('sopNameInput').value = sop.name;
  document.getElementById('sopTitle').textContent = sop.name;
  document.getElementById('tagsInput').value = tags.join(', ');
  document.getElementById('statusSelect').value = sopStatus;
  document.getElementById('categorySelect').value = sopCategory;
  document.getElementById('totalTimeInput').value = totalTimeEstimate;
  
  if (isMobile) toggleSidebar();
  
  renderSOPList();
  renderSteps();
  renderDiagram();
  renderTags();
  renderStepTimes();
  updateTimeDisplay();
  updateHistoryButtons();
  markSaved();
}

function renameSOPQuick() {
  if (!currentSOPId) return;
  const newName = prompt("New SOP name:", allSOPs[currentSOPId].name);
  if (!newName || !newName.trim()) return;
  
  const oldName = allSOPs[currentSOPId].name;
  allSOPs[currentSOPId].name = newName.trim();
  document.getElementById('sopTitle').textContent = newName.trim();
  document.getElementById('sopNameInput').value = newName.trim();
  logChangeLog(currentSOPId, `Renamed from "${oldName}" to "${newName.trim()}"`);
  renderSOPList();
  saveToStorage();
}

function updateSOPName() {
  if (!currentSOPId) return;
  const newName = document.getElementById('sopNameInput').value.trim();
  if (newName) {
    allSOPs[currentSOPId].name = newName;
    document.getElementById('sopTitle').textContent = newName;
    renderSOPList();
    saveToStorage();
  }
}

function deleteSOP(id) {
  if (!confirm('Delete this SOP? Move to trash?')) return;
  
  const sop = allSOPs[id];
  trash[id] = { ...sop, deletedAt: new Date().toISOString() };
  delete allSOPs[id];
  
  if (currentSOPId === id) {
    const firstSOP = Object.keys(allSOPs)[0];
    if (firstSOP) loadSOP(firstSOP);
    else createNewSOP();
  }
  
  renderSOPList();
  saveToStorage();
}

function permanentlyDelete(id) {
  if (!confirm('Permanently delete? Cannot be undone.')) return;
  delete trash[id];
  saveToStorage();
  viewTrash();
}

function restoreFromTrash(id) {
  if (trash[id]) {
    allSOPs[id] = trash[id];
    delete trash[id];
    saveToStorage();
    renderSOPList();
    document.getElementById('trashModal').classList.remove('active');
  }
}

function viewTrash() {
  const container = document.getElementById('trashList');
  const trashedIds = Object.keys(trash);
  
  if (trashedIds.length === 0) {
    container.innerHTML = '<p style="color: #999;">Trash is empty.</p>';
  } else {
    container.innerHTML = trashedIds.map(id => {
      const sop = trash[id];
      const deletedTime = new Date(sop.deletedAt).toLocaleString();
      return `
        <div style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin: 6px 0;">
          <strong>${escapeHtml(sop.name)}</strong>
          <div style="font-size: 10px; color: #666; margin-top: 3px;">Deleted: ${deletedTime}</div>
          <div style="display: flex; gap: 4px; margin-top: 6px;">
            <button onclick="restoreFromTrash('${id}')" class="secondary" style="padding: 3px 6px; font-size: 10px; flex: 1;">Restore</button>
            <button onclick="permanentlyDelete('${id}')" class="danger" style="padding: 3px 6px; font-size: 10px; flex: 1;">Delete</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  document.getElementById('trashModal').classList.add('active');
}

function searchSOPs() {
  const query = document.getElementById('searchBox').value.toLowerCase();
  renderSOPList(query);
}

// ============ STEPS ============
function addStep(text = "New Step") {
  steps.push({ text, branches: [], duration: 0 });
  saveHistory();
  markUnsaved();
  render();
  logChangeLog(currentSOPId, 'Added step: ' + text);
}

function updateStep(idx, value) {
  if (idx >= 0 && idx < steps.length) {
    steps[idx].text = value;
    saveHistory();
    markUnsaved();
    render();
  }
}

function deleteStep(idx) {
  if (steps.length === 1) {
    alert('You must have at least one step.');
    return;
  }
  const deletedStep = steps[idx].text;
  steps.splice(idx, 1);
  saveHistory();
  markUnsaved();
  render();
  logChangeLog(currentSOPId, 'Deleted step: ' + deletedStep);
}

function moveStep(fromIdx, toIdx) {
  if (fromIdx < 0 || fromIdx >= steps.length || toIdx < 0 || toIdx >= steps.length) return;
  const [step] = steps.splice(fromIdx, 1);
  steps.splice(toIdx, 0, step);
  saveHistory();
  markUnsaved();
  render();
}

function addBranch(stepIdx) {
  const branchText = prompt("Enter branch step text:");
  if (!branchText || !branchText.trim()) return;
  
  if (stepIdx >= 0 && stepIdx < steps.length) {
    steps[stepIdx].branches.push({ text: branchText.trim(), branches: [], duration: 0 });
    saveHistory();
    markUnsaved();
    render();
    logChangeLog(currentSOPId, 'Added branch: ' + branchText.trim());
  }
}

function deleteBranch(stepIdx, branchIdx) {
  if (stepIdx >= 0 && stepIdx < steps.length && branchIdx >= 0 && branchIdx < steps[stepIdx].branches.length) {
    steps[stepIdx].branches.splice(branchIdx, 1);
    saveHistory();
    markUnsaved();
    render();
  }
}

function updateBranch(stepIdx, branchIdx, value) {
  if (stepIdx >= 0 && stepIdx < steps.length && branchIdx >= 0 && branchIdx < steps[stepIdx].branches.length) {
    steps[stepIdx].branches[branchIdx].text = value;
    saveHistory();
    markUnsaved();
    render();
  }
}

// ============ TAGS ============
function updateTags() {
  const input = document.getElementById('tagsInput').value;
  tags = input.split(',').map(t => t.trim()).filter(t => t);
  renderTags();
  if (currentSOPId) {
    allSOPs[currentSOPId].tags = tags;
    saveToStorage();
  }
}

function renderTags() {
  const container = document.getElementById('tagsList');
  container.innerHTML = tags.map(tag => 
    `<span class="tag">${escapeHtml(tag)}<span class="remove" onclick="removeTag('${tag}')">√ó</span></span>`
  ).join('');
}

function removeTag(tag) {
  tags = tags.filter(t => t !== tag);
  document.getElementById('tagsInput').value = tags.join(', ');
  updateTags();
}

// ============ COMMENTS ============
function addComment() {
  const author = document.getElementById('commentAuthorInput').value.trim() || 'Anonymous';
  const text = document.getElementById('commentTextInput').value.trim();
  
  if (!text) return;
  
  comments.push({
    author,
    text,
    timestamp: new Date().toISOString()
  });
  
  document.getElementById('commentTextInput').value = '';
  document.getElementById('commentAuthorInput').value = '';
  renderComments();
  if (currentSOPId) {
    allSOPs[currentSOPId].comments = comments;
    saveToStorage();
  }
}

function renderComments() {
  const container = document.getElementById('commentsList');
  container.innerHTML = comments.length === 0
    ? '<p style="color: #999; font-size: 11px;">No comments yet.</p>'
    : comments.map(comment => {
      const time = new Date(comment.timestamp).toLocaleString();
      return `
        <div class="comment">
          <strong>${escapeHtml(comment.author)}</strong> <span style="color: #999;">¬∑ ${time}</span>
          <div style="margin-top: 4px; color: #555;">${escapeHtml(comment.text)}</div>
        </div>
      `;
    }).join('');
}

function openCommentModal() {
  document.getElementById('commentModal').classList.add('active');
  renderComments();
}

function closeCommentModal() {
  document.getElementById('commentModal').classList.remove('active');
}

// ============ VERSIONING ============
function saveHistory() {
  const stateStr = JSON.stringify(steps);
  history.push(stateStr);
  redoStack = [];
  
  if (history.length > 50) history.shift();
  if (history.length % 5 === 0 && currentSOPId) {
    versions.unshift({
      timestamp: new Date().toISOString(),
      steps: JSON.parse(stateStr),
      stepCount: steps.length
    });
    if (versions.length > 20) versions.pop();
    allSOPs[currentSOPId].versions = versions;
    saveToStorage();
  }
  
  updateHistoryButtons();
}

function undo() {
  if (history.length > 1) {
    redoStack.push(history.pop());
    steps = JSON.parse(history[history.length - 1]);
    render();
    updateHistoryButtons();
  }
}

function redo() {
  if (redoStack.length) {
    const state = redoStack.pop();
    steps = JSON.parse(state);
    history.push(state);
    render();
    updateHistoryButtons();
  }
}

function updateHistoryButtons() {
  document.getElementById('undoBtn').disabled = history.length <= 1;
  document.getElementById('redoBtn').disabled = redoStack.length === 0;
}

function openVersionsModal() {
  const container = document.getElementById('versionsList');
  container.innerHTML = versions.length === 0 
    ? '<p style="color: #999;">No version history yet.</p>'
    : versions.map((v, idx) => {
      const time = new Date(v.timestamp).toLocaleString();
      return `
        <div class="version-item">
          <div class="version-item-header">
            <strong>Version ${versions.length - idx}</strong> ‚Ä¢ ${v.stepCount} steps
            <span style="color: #999;">${time}</span>
          </div>
          <div style="display: flex; gap: 4px; margin-top: 6px;">
            <button onclick="restoreVersion(${idx})" style="padding: 3px 6px; font-size: 10px; flex: 1;">Restore</button>
            <button onclick="viewVersion(${idx})" class="tertiary" style="padding: 3px 6px; font-size: 10px; flex: 1;">Preview</button>
          </div>
        </div>
      `;
    }).join('');
  
  document.getElementById('versionsModal').classList.add('active');
}

function closeVersionsModal() {
  document.getElementById('versionsModal').classList.remove('active');
}

function restoreVersion(idx) {
  if (!confirm('Restore to this version?')) return;
  
  steps = JSON.parse(JSON.stringify(versions[idx].steps));
  history = [JSON.stringify(steps)];
  redoStack = [];
  render();
  updateHistoryButtons();
  saveHistory();
}

function viewVersion(idx) {
  const stepTexts = versions[idx].steps.map(s => '‚Ä¢ ' + s.text).join('\n');
  alert('Version from ' + new Date(versions[idx].timestamp).toLocaleString() + '\n\n' + stepTexts);
}

// ============ RENDERING ============
function renderSOPList(query = '') {
  const container = document.getElementById('sopList');
  const sopIds = Object.keys(allSOPs);
  
  const filtered = sopIds.filter(id => {
    const sop = allSOPs[id];
    return sop.name.toLowerCase().includes(query) || 
           sop.tags.some(t => t.toLowerCase().includes(query));
  });
  
  if (filtered.length === 0) {
    container.innerHTML = '<p style="color: #aaa; padding: 12px; text-align: center; font-size: 11px;">No SOPs found</p>';
    return;
  }
  
  container.innerHTML = filtered.map(id => {
    const sop = allSOPs[id];
    const isActive = currentSOPId === id;
    const time = new Date(sop.updatedAt).toLocaleDateString();
    return `
      <div class="sop-item ${isActive ? 'active' : ''}" onclick="loadSOP('${id}')" role="button" tabindex="0" onkeypress="if(event.key==='Enter') loadSOP('${id}')">
        <div class="sop-item-name">${escapeHtml(sop.name)}</div>
        <div class="sop-item-meta">${sop.steps.length} steps ‚Ä¢ ${time}</div>
        <div class="sop-item-actions">
          <button onclick="event.stopPropagation(); openCommentModal()" title="Comments">üí¨</button>
          <button onclick="event.stopPropagation(); deleteSOP('${id}')" title="Delete" class="danger">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }).join('');
}

function renderSteps() {
  const container = document.getElementById('stepsList');
  container.innerHTML = '';
  
  if (steps.length === 0) {
    container.innerHTML = '<div class="empty-state">No steps yet. Add one to get started.</div>';
    return;
  }
  
  steps.forEach((step, idx) => {
    const div = document.createElement('div');
    div.className = 'step-card';
    div.draggable = true;
    div.dataset.index = idx;
    
    div.addEventListener('dragstart', (e) => {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('stepIndex', idx);
      div.classList.add('dragging');
    });
    
    div.addEventListener('dragend', () => {
      div.classList.remove('dragging');
    });
    
    div.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });
    
    div.addEventListener('drop', (e) => {
      e.preventDefault();
      const fromIdx = parseInt(e.dataTransfer.getData('stepIndex'));
      if (fromIdx !== idx && !isNaN(fromIdx)) {
        moveStep(fromIdx, idx);
      }
    });
    
    let branchesHTML = '';
    step.branches.forEach((branch, bIdx) => {
      branchesHTML += `
        <div class="branch">
          <input class="step-input" value="${escapeHtml(branch.text)}" 
                 onchange="updateBranch(${idx},${bIdx},this.value)"/>
          <button class="tertiary" onclick="deleteBranch(${idx},${bIdx})" style="padding: 2px 4px; font-size: 10px;">Delete</button>
        </div>
      `;
    });
    
    div.innerHTML = `
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="step-number">${idx + 1}</span>
        <input class="step-input" style="margin: 0; flex: 1;" value="${escapeHtml(step.text)}" 
               onchange="updateStep(${idx},this.value)"/>
        <input type="number" min="0" value="${step.duration || 0}" 
               style="width: 50px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;"
               onchange="updateStepDuration(${idx}, this.value)" 
               placeholder="min">
      </div>
      <div class="step-controls">
        <button onclick="addBranch(${idx})">+ Branch</button>
        <button class="tertiary" onclick="deleteStep(${idx})">Delete</button>
      </div>
      ${branchesHTML}
    `;
    
    container.appendChild(div);
  });
}

function renderDiagram() {
  const svg = document.getElementById('svgDiagram');
  svg.innerHTML = '';
  
  if (steps.length === 0) {
    svg.innerHTML = `<div style="text-align: center; color: #ccc; font-size: 14px;">Add steps to see diagram</div>`;
    return;
  }
  
  const svgNS = "http://www.w3.org/2000/svg";
  let y = 20;
  const nodeHeight = 50;
  const nodeWidth = 140;
  const vGap = 80;
  
  const drawStep = (step, level = 0, parentX = null, parentY = null) => {
    const x = 40 + level * 180;
    
    if (parentX !== null && parentY !== null) {
      const line = document.createElementNS(svgNS, 'line');
      line.setAttribute('x1', parentX + nodeWidth / 2);
      line.setAttribute('y1', parentY + nodeHeight);
      line.setAttribute('x2', x + nodeWidth / 2);
      line.setAttribute('y2', y);
      line.setAttribute('stroke', '#ccc');
      line.setAttribute('stroke-width', '1');
      svg.appendChild(line);
    }
    
    const rect = document.createElementNS(svgNS, 'rect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', nodeWidth);
    rect.setAttribute('height', nodeHeight);
    rect.setAttribute('fill', level === 0 ? '#4CAF50' : '#2196F3');
    rect.setAttribute('rx', '3');
    rect.setAttribute('stroke', '#333');
    rect.setAttribute('stroke-width', '1');
    svg.appendChild(rect);
    
    const text = document.createElementNS(svgNS, 'text');
    text.setAttribute('x', x + nodeWidth / 2);
    text.setAttribute('y', y + nodeHeight / 2);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('dominant-baseline', 'middle');
    text.setAttribute('fill', '#fff');
    text.setAttribute('font-size', '10');
    text.setAttribute('font-weight', '600');
    text.textContent = step.text.substring(0, 15) + (step.text.length > 15 ? '...' : '');
    svg.appendChild(text);
    
    let currentY = y;
    y += vGap;
    
    if (step.branches && step.branches.length > 0) {
      step.branches.forEach(b => {
        drawStep(b, level + 1, x, currentY);
      });
    }
  };
  
  steps.forEach(s => drawStep(s));
}

function render() {
  renderSteps();
  renderDiagram();
  if (currentSOPId && steps.length > 0) {
    allSOPs[currentSOPId].steps = steps;
    allSOPs[currentSOPId].updatedAt = new Date().toISOString();
  }
}

// ============ PHASE 1 FEATURES ============
function updateSOPStatus(newStatus) {
  if (!currentSOPId) return;
  sopStatus = newStatus;
  allSOPs[currentSOPId].status = newStatus;
  document.getElementById('sopStatus').textContent = newStatus;
  logAuditTrail(currentSOPId, 'status_changed', { from: sopStatus, to: newStatus });
  logChangeLog(currentSOPId, 'Status changed to ' + newStatus);
  renderSOPList();
  saveToStorage();
}

function updateSOPCategory(newCategory) {
  if (!currentSOPId) return;
  sopCategory = newCategory;
  allSOPs[currentSOPId].category = newCategory;
  logAuditTrail(currentSOPId, 'category_changed', { category: newCategory });
  renderSOPList();
  saveToStorage();
}

function updateStepDuration(idx, duration) {
  if (idx >= 0 && idx < steps.length) {
    steps[idx].duration = parseInt(duration) || 0;
    saveHistory();
    markUnsaved();
    updateTimeDisplay();
    renderStepTimes();
  }
}

function updateTotalTime(minutes) {
  if (!currentSOPId) return;
  totalTimeEstimate = parseInt(minutes) || 0;
  allSOPs[currentSOPId].totalTime = totalTimeEstimate;
  updateTimeDisplay();
  saveToStorage();
}

function updateTimeDisplay() {
  const total = totalTimeEstimate || calculateTotalStepTime();
  const hours = Math.floor(total / 60);
  const mins = total % 60;
  
  let displayText = '';
  if (hours > 0) {
    displayText = `${hours}h ${mins}m`;
  } else if (total > 0) {
    displayText = `${total}m`;
  } else {
    displayText = 'No estimate';
  }
  
  document.getElementById('timeDisplay').textContent = displayText;
}

function calculateTotalStepTime() {
  return steps.reduce((total, step) => total + (step.duration || 0), 0);
}

function renderStepTimes() {
  const container = document.getElementById('stepTimesDisplay');
  const stepTimes = steps
    .map((step, idx) => {
      const duration = step.duration || 0;
      return duration > 0 ? `Step ${idx + 1}: ${duration}m` : null;
    })
    .filter(Boolean);
  
  if (stepTimes.length === 0) {
    container.innerHTML = '';
  } else {
    container.innerHTML = stepTimes.join(' ‚Ä¢ ');
  }
}

// ============ PHASE 2 FEATURES - Collaboration ============

function updateSOPOwner(ownerName) {
  if (!currentSOPId) return;
  const oldOwner = sopOwner;
  sopOwner = ownerName;
  allSOPs[currentSOPId].owner = ownerName;
  logAuditTrail(currentSOPId, 'owner_changed', { from: oldOwner || 'Unassigned', to: ownerName || 'Unassigned' });
  logChangeLog(currentSOPId, 'Owner changed to ' + (ownerName || 'Unassigned'));
  renderOwnerDisplay();
  saveToStorage();
}

function renderOwnerDisplay() {
  const container = document.getElementById('ownerDisplay');
  if (sopOwner) {
    container.textContent = 'Owner: ' + sopOwner;
  } else {
    container.textContent = 'No owner assigned';
  }
}

function markReviewedNow() {
  if (!currentSOPId) return;
  const reviewer = sopOwner || localStorage.getItem('currentUser') || 'System';
  const now = new Date().toISOString();
  
  allSOPs[currentSOPId].lastReviewedBy = reviewer;
  allSOPs[currentSOPId].lastReviewedDate = now;
  
  logAuditTrail(currentSOPId, 'reviewed', { reviewedBy: reviewer });
  logChangeLog(currentSOPId, 'Reviewed by ' + reviewer);
  
  renderReviewDisplay();
  saveToStorage();
}

function renderReviewDisplay() {
  const container = document.getElementById('reviewDisplay');
  const sop = allSOPs[currentSOPId];
  
  if (sop && sop.lastReviewedDate) {
    const date = new Date(sop.lastReviewedDate).toLocaleDateString();
    container.textContent = `Last reviewed: ${date} by ${sop.lastReviewedBy || 'Unknown'}`;
  } else {
    container.textContent = 'Never reviewed';
  }
}

function logChangeLog(sopId, action) {
  if (!allSOPs[sopId]) return;
  if (!allSOPs[sopId].changeLog) {
    allSOPs[sopId].changeLog = [];
  }
  
  allSOPs[sopId].changeLog.unshift({
    timestamp: new Date().toISOString(),
    action: action,
    user: localStorage.getItem('currentUser') || 'System'
  });
  
  if (allSOPs[sopId].changeLog.length > 100) {
    allSOPs[sopId].changeLog.pop();
  }
  
  changeLog = allSOPs[sopId].changeLog;
}

function logAuditTrail(sopId, action, details) {
  if (!allSOPs[sopId]) return;
  if (!allSOPs[sopId].auditTrail) {
    allSOPs[sopId].auditTrail = [];
  }
  
  allSOPs[sopId].auditTrail.unshift({
    timestamp: new Date().toISOString(),
    action: action,
    details: details || {},
    user: localStorage.getItem('currentUser') || 'System'
  });
  
  if (allSOPs[sopId].auditTrail.length > 200) {
    allSOPs[sopId].auditTrail.pop();
  }
  
  auditTrail = allSOPs[sopId].auditTrail;
}

function viewAuditTrail() {
  const container = document.getElementById('auditTrailList');
  
  if (auditTrail.length === 0) {
    container.innerHTML = '<p style="color: #999; font-size: 11px;">No activity recorded.</p>';
  } else {
    container.innerHTML = auditTrail.slice(0, 100).map(entry => {
      const time = new Date(entry.timestamp).toLocaleString();
      const actionLabel = {
        'created': 'Created',
        'status_changed': 'Status changed',
        'category_changed': 'Category changed',
        'owner_changed': 'Owner changed',
        'reviewed': 'Reviewed',
        'edited': 'Edited'
      };
      
      const label = actionLabel[entry.action] || entry.action;
      const details = entry.details ? ` - ${JSON.stringify(entry.details).substring(0, 40)}` : '';
      
      return `
        <div style="padding: 8px; background: #f9f9f9; border: 1px solid #eee; border-radius: 3px; margin: 6px 0; font-size: 10px;">
          <div style="font-weight: 600; color: #333;">${label}</div>
          <div style="color: #666; margin-top: 2px;">By: ${entry.user}</div>
          <div style="color: #999; margin-top: 2px;">${time}${details}</div>
        </div>
      `;
    }).join('');
  }
  
  document.getElementById('auditModal').classList.add('active');
}

function filterAuditTrail() {
  const query = document.getElementById('auditFilterInput').value.toLowerCase();
  const filtered = auditTrail.filter(entry => 
    entry.action.toLowerCase().includes(query) || 
    entry.user.toLowerCase().includes(query)
  );
  
  const container = document.getElementById('auditTrailList');
  if (filtered.length === 0) {
    container.innerHTML = '<p style="color: #999; font-size: 11px;">No matches found.</p>';
    return;
  }
  
  container.innerHTML = filtered.slice(0, 100).map(entry => {
    const time = new Date(entry.timestamp).toLocaleString();
    const actionLabel = {
      'created': 'Created',
      'status_changed': 'Status changed',
      'category_changed': 'Category changed',
      'owner_changed': 'Owner changed',
      'reviewed': 'Reviewed',
      'edited': 'Edited'
    };
    
    const label = actionLabel[entry.action] || entry.action;
    const details = entry.details ? ` - ${JSON.stringify(entry.details).substring(0, 40)}` : '';
    
    return `
      <div style="padding: 8px; background: #f9f9f9; border: 1px solid #eee; border-radius: 3px; margin: 6px 0; font-size: 10px;">
        <div style="font-weight: 600; color: #333;">${label}</div>
        <div style="color: #666; margin-top: 2px;">By: ${entry.user}</div>
        <div style="color: #999; margin-top: 2px;">${time}${details}</div>
      </div>
    `;
  }).join('');
}

function viewChangeLog() {
  const container = document.getElementById('changeLogList');
  
  if (changeLog.length === 0) {
    container.innerHTML = '<p style="color: #999; font-size: 11px;">No changes recorded.</p>';
  } else {
    container.innerHTML = changeLog.slice(0, 100).map(entry => {
      const time = new Date(entry.timestamp).toLocaleString();
      return `
        <div style="padding: 8px; background: #f9f9f9; border-left: 3px solid #4CAF50; border-radius: 2px; margin: 6px 0; font-size: 10px;">
          <div style="color: #333;">${entry.action}</div>
          <div style="color: #666; margin-top: 2px;">${entry.user}</div>
          <div style="color: #999; margin-top: 2px;">${time}</div>
        </div>
      `;
    }).join('');
  }
  
  document.getElementById('changeLogModal').classList.add('active');
}

function filterChangeLog() {
  const query = document.getElementById('changeFilterInput').value.toLowerCase();
  const filtered = changeLog.filter(entry => 
    entry.action.toLowerCase().includes(query) || 
    entry.user.toLowerCase().includes(query)
  );
  
  const container = document.getElementById('changeLogList');
  if (filtered.length === 0) {
    container.innerHTML = '<p style="color: #999; font-size: 11px;">No matches found.</p>';
    return;
  }
  
  container.innerHTML = filtered.slice(0, 100).map(entry => {
    const time = new Date(entry.timestamp).toLocaleString();
    return `
      <div style="padding: 8px; background: #f9f9f9; border-left: 3px solid #4CAF50; border-radius: 2px; margin: 6px 0; font-size: 10px;">
        <div style="color: #333;">${entry.action}</div>
        <div style="color: #666; margin-top: 2px;">${entry.user}</div>
        <div style="color: #999; margin-top: 2px;">${time}</div>
      </div>
    `;
  }).join('');
}

function closeAuditModal() {
  document.getElementById('auditModal').classList.remove('active');
}

function closeChangeLogModal() {
  document.getElementById('changeLogModal').classList.remove('active');
}

// ============ PHASE 3 FEATURES - Analytics ============

function trackSOPView(sopId) {
  if (!usageStats[sopId]) {
    usageStats[sopId] = {
      views: 0,
      lastViewed: null,
      totalTimeSpent: 0
    };
  }
  
  usageStats[sopId].views++;
  usageStats[sopId].lastViewed = new Date().toISOString();
  
  localStorage.setItem('usageStats', JSON.stringify(usageStats));
}

function viewSOPAnalytics() {
  const container = document.getElementById('analyticsContent');
  const sop = allSOPs[currentSOPId];
  const stats = usageStats[currentSOPId];
  
  if (!stats) {
    container.innerHTML = '<p style="color: #999;">No usage data recorded yet.</p>';
    document.getElementById('analyticsModal').classList.add('active');
    return;
  }
  
  const lastViewed = stats.lastViewed ? new Date(stats.lastViewed).toLocaleDateString() : 'Never';
  const daysOld = Math.floor((Date.now() - new Date(sop.createdAt)) / (1000 * 60 * 60 * 24));
  const avgViewsPerDay = stats.views > 0 ? (stats.views / Math.max(daysOld, 1)).toFixed(1) : 0;
  
  // Review compliance
  let reviewStatus = 'Never reviewed';
  let reviewColor = '#ffcccc';
  if (sop.lastReviewedDate) {
    const daysSinceReview = Math.floor((Date.now() - new Date(sop.lastReviewedDate)) / (1000 * 60 * 60 * 24));
    if (daysSinceReview > 365) {
      reviewStatus = `Overdue - ${daysSinceReview} days since review`;
      reviewColor = '#ffcccc';
    } else if (daysSinceReview > 180) {
      reviewStatus = `Due soon - ${daysSinceReview} days since review`;
      reviewColor = '#fff3cd';
    } else {
      reviewStatus = `Current - reviewed ${daysSinceReview} days ago`;
      reviewColor = '#ccffcc';
    }
  }
  
  const stepCount = steps.length;
  const completeness = Math.round(((sop.owner ? 1 : 0) + (sop.status === 'ACTIVE' ? 1 : 0) + (stepCount > 0 ? 1 : 0)) / 3 * 100);
  const daysSinceUpdate = Math.floor((Date.now() - new Date(sop.updatedAt)) / (1000 * 60 * 60 * 24));
  
  container.innerHTML = `
    <div style="line-height: 1.8; font-size: 11px;">
      <div style="padding: 8px; background: #f0f7ff; border-left: 3px solid #2196F3; border-radius: 3px; margin: 8px 0;">
        <strong>Usage</strong><br>
        Total views: ${stats.views}<br>
        Last viewed: ${lastViewed}<br>
        Avg per day: ${avgViewsPerDay}
      </div>
      
      <div style="padding: 8px; background: ${reviewColor}; border-left: 3px solid #FF9800; border-radius: 3px; margin: 8px 0;">
        <strong>Review Status</strong><br>
        ${reviewStatus}
      </div>
      
      <div style="padding: 8px; background: #f5f5f5; border-left: 3px solid #4CAF50; border-radius: 3px; margin: 8px 0;">
        <strong>Completeness: ${completeness}%</strong><br>
        Steps: ${stepCount} defined<br>
        Owner: ${sop.owner ? sop.owner : 'Not assigned'}<br>
        Status: ${sop.status}
      </div>
      
      <div style="padding: 8px; background: #f5f5f5; border-left: 3px solid #666; border-radius: 3px; margin: 8px 0;">
        <strong>Timeline</strong><br>
        Created: ${daysOld} days ago<br>
        Updated: ${daysSinceUpdate} days ago<br>
        Changes: ${changeLog.length} total
      </div>
    </div>
  `;
  
  document.getElementById('analyticsModal').classList.add('active');
}

function viewDashboard() {
  const container = document.getElementById('dashboardContent');
  
  const now = Date.now();
  const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);
  const ninetyDaysAgo = now - (90 * 24 * 60 * 60 * 1000);
  const oneYearAgo = now - (365 * 24 * 60 * 60 * 1000);
  
  let stats = {
    total: Object.keys(allSOPs).length,
    byStatus: { ACTIVE: 0, DRAFT: 0, REVIEW: 0, ARCHIVED: 0 },
    overdueReviews: [],
    upToDate: [],
    neverReviewed: [],
    noOwner: [],
    inactive: [],
    recentlyCreated: []
  };
  
  Object.entries(allSOPs).forEach(([id, sop]) => {
    stats.byStatus[sop.status]++;
    
    const usage = usageStats[id];
    const views = usage ? usage.views : 0;
    
    // Check review status
    if (sop.lastReviewedDate) {
      const daysSinceReview = Math.floor((now - new Date(sop.lastReviewedDate)) / (1000 * 60 * 60 * 24));
      if (daysSinceReview > 365) {
        stats.overdueReviews.push({
          name: sop.name,
          daysAgo: daysSinceReview,
          owner: sop.owner || 'Unassigned'
        });
      } else if (daysSinceReview < 90) {
        stats.upToDate.push({
          name: sop.name,
          daysAgo: daysSinceReview,
          owner: sop.owner || 'N/A'
        });
      }
    } else {
      stats.neverReviewed.push({
        name: sop.name,
        owner: sop.owner || 'Unassigned',
        createdDaysAgo: Math.floor((now - new Date(sop.createdAt)) / (1000 * 60 * 60 * 24))
      });
    }
    
    // Check ownership
    if (!sop.owner) {
      stats.noOwner.push(sop.name);
    }
    
    // Check inactive (no views in 30 days + not updated)
    const daysSinceUpdate = Math.floor((now - new Date(sop.updatedAt)) / (1000 * 60 * 60 * 24));
    const lastViewTime = usage && usage.lastViewed ? new Date(usage.lastViewed).getTime() : 0;
    const daysSinceView = lastViewTime ? Math.floor((now - lastViewTime) / (1000 * 60 * 60 * 24)) : 999;
    
    if (daysSinceUpdate > 90 && daysSinceView > 30) {
      stats.inactive.push({
        name: sop.name,
        daysSinceUpdate: daysSinceUpdate,
        views: views
      });
    }
    
    // Recently created
    const daysOld = Math.floor((now - new Date(sop.createdAt)) / (1000 * 60 * 60 * 24));
    if (daysOld < 30) {
      stats.recentlyCreated.push({
        name: sop.name,
        daysOld: daysOld,
        status: sop.status
      });
    }
  });
  
  // Calculate compliance
  const activePercent = stats.total > 0 ? Math.round((stats.byStatus.ACTIVE / stats.total) * 100) : 0;
  const reviewedPercent = stats.total > 0 ? Math.round(((stats.byStatus.ACTIVE - stats.neverReviewed.length) / stats.total) * 100) : 0;
  const ownedPercent = stats.total > 0 ? Math.round(((stats.total - stats.noOwner.length) / stats.total) * 100) : 0;
  
  let html = `
    <div style="font-size: 11px; line-height: 1.8;">
      <div style="padding: 10px; background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 3px; margin: 8px 0;">
        <strong style="font-size: 12px;">Organization Summary</strong><br>
        Total SOPs: ${stats.total}<br>
        Active: ${stats.byStatus.ACTIVE} | Draft: ${stats.byStatus.DRAFT} | Review: ${stats.byStatus.REVIEW} | Archived: ${stats.byStatus.ARCHIVED}
      </div>
      
      <div style="padding: 10px; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 3px; margin: 8px 0;">
        <strong style="font-size: 12px;">Compliance Metrics</strong><br>
        Active: ${activePercent}%<br>
        Reviewed: ${reviewedPercent}%<br>
        Owned: ${ownedPercent}%
      </div>
  `;
  
  if (stats.overdueReviews.length > 0) {
    html += `
      <div style="padding: 10px; background: #ffcccc; border-left: 4px solid #f44336; border-radius: 3px; margin: 8px 0;">
        <strong style="font-size: 12px;">‚ö†Ô∏è Overdue Reviews (>365 days)</strong><br>
        ${stats.overdueReviews.slice(0, 3).map(s => `‚Ä¢ ${s.name} (${s.daysAgo} days, Owner: ${s.owner})`).join('<br>')}
        ${stats.overdueReviews.length > 3 ? `<br>... and ${stats.overdueReviews.length - 3} more` : ''}
      </div>
    `;
  }
  
  if (stats.neverReviewed.length > 0) {
    html += `
      <div style="padding: 10px; background: #fff3cd; border-left: 4px solid #FF9800; border-radius: 3px; margin: 8px 0;">
        <strong style="font-size: 12px;">‚ö†Ô∏è Never Reviewed (${stats.neverReviewed.length})</strong><br>
        ${stats.neverReviewed.slice(0, 3).map(s => `‚Ä¢ ${s.name} (Created ${s.createdDaysAgo} days ago)`).join('<br>')}
        ${stats.neverReviewed.length > 3 ? `<br>... and ${stats.neverReviewed.length - 3} more` : ''}
      </div>
    `;
  }
  
  if (stats.noOwner.length > 0) {
    html += `
      <div style="padding: 10px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 3px; margin: 8px 0;">
        <strong style="font-size: 12px;">‚ö†Ô∏è Missing Owners (${stats.noOwner.length})</strong><br>
        ${stats.noOwner.slice(0, 3).join(', ')}${stats.noOwner.length > 3 ? ', ...' : ''}
      </div>
    `;
  }
  
  if (stats.inactive.length > 0) {
    html += `
      <div style="padding: 10px; background: #f5f5f5; border-left: 4px solid #999; border-radius: 3px; margin: 8px 0;">
        <strong style="font-size: 12px;">üìå Potentially Outdated (${stats.inactive.length})</strong><br>
        ${stats.inactive.slice(0, 3).map(s => `‚Ä¢ ${s.name} (${s.daysSinceUpdate} days old, ${s.views} views)`).join('<br>')}
        ${stats.inactive.length > 3 ? `<br>... and ${stats.inactive.length - 3} more` : ''}
      </div>
    `;
  }
  
  if (stats.upToDate.length > 0) {
    html += `
      <div style="padding: 10px; background: #ccffcc; border-left: 4px solid #4CAF50; border-radius: 3px; margin: 8px 0;">
        <strong style="font-size: 12px;">‚úì Current & Reviewed (${stats.upToDate.length})</strong><br>
        Recent review compliance is good!
      </div>
    `;
  }
  
  html += '</div>';
  
  container.innerHTML = html;
  document.getElementById('dashboardModal').classList.add('active');
}

function closeAnalyticsModal() {
  document.getElementById('analyticsModal').classList.remove('active');
}

function closeDashboardModal() {
  document.getElementById('dashboardModal').classList.remove('active');
}

// ============ EXPORT ============
function exportOptions() {
  document.getElementById('exportModal').classList.add('active');
}

function closeExportModal() {
  document.getElementById('exportModal').classList.remove('active');
}

function exportPDF() {
  const sopName = currentSOPId ? allSOPs[currentSOPId].name : 'SOP';
  const docContent = steps.map((s, i) => {
    let text = `${i + 1}. ${s.text}`;
    if (s.duration) text += ` (${s.duration}m)`;
    if (s.branches && s.branches.length) {
      s.branches.forEach((b, idx) => {
        text += `\n   ${String.fromCharCode(97 + idx)}. ${b.text}`;
        if (b.duration) text += ` (${b.duration}m)`;
      });
    }
    return text;
  }).join('\n\n');
  
  const html = `<html><head><title>${escapeHtml(sopName)}</title><style>body{font-family:Arial;padding:40px}h1{border-bottom:2px solid #4CAF50;padding-bottom:10px}pre{white-space:pre-wrap}</style></head><body><h1>${escapeHtml(sopName)}</h1><p>${new Date().toLocaleString()}</p><pre>${escapeHtml(docContent)}</pre></body></html>`;
  
  const printWindow = window.open('', '', 'width=900,height=700');
  printWindow.document.write(html);
  printWindow.document.close();
  setTimeout(() => printWindow.print(), 500);
  closeExportModal();
}

function exportHTML() {
  const sopName = currentSOPId ? allSOPs[currentSOPId].name : 'SOP';
  const stepsHTML = steps.map((s, i) => {
    let html = `<li>${escapeHtml(s.text)}`;
    if (s.duration) html += ` <span style="color:#666">(${s.duration}m)</span>`;
    if (s.branches && s.branches.length) {
      html += '<ul>' + s.branches.map(b => `<li>${escapeHtml(b.text)}</li>`).join('') + '</ul>';
    }
    html += '</li>';
    return html;
  }).join('');
  
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${escapeHtml(sopName)}</title><style>body{font-family:Arial;padding:40px;max-width:800px}</style></head><body><h1>${escapeHtml(sopName)}</h1><p>${new Date().toLocaleString()}</p><ol>${stepsHTML}</ol></body></html>`;
  
  downloadFile(html, sopName + '.html', 'text/html');
  closeExportModal();
}

function exportCSV() {
  const sopName = currentSOPId ? allSOPs[currentSOPId].name : 'SOP';
  let csv = 'Step,Text,Branch,Duration\n';
  
  steps.forEach((s, i) => {
    csv += `${i + 1},"${s.text.replace(/"/g, '""')}","",${s.duration || 0}\n`;
    if (s.branches && s.branches.length) {
      s.branches.forEach(b => {
        csv += `${i + 1},"${s.text.replace(/"/g, '""')}","${b.text.replace(/"/g, '""')}",${b.duration || 0}\n`;
      });
    }
  });
  
  downloadFile(csv, sopName + '.csv', 'text/csv');
  closeExportModal();
}

function exportDiagramImage() {
  const svg = document.getElementById('svgDiagram');
  const svgData = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  
  canvas.width = 1200;
  canvas.height = 800;
  
  img.onload = function() {
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = (currentSOPId ? allSOPs[currentSOPId].name : 'diagram') + '.png';
    link.click();
    closeExportModal();
  };
  
  img.onerror = () => {
    alert('Could not export diagram.');
    closeExportModal();
  };
  
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
}

function exportAllSOPs() {
  try {
    const backup = {
      version: 1,
      exportDate: new Date().toISOString(),
      sopCount: Object.keys(allSOPs).length,
      data: allSOPs
    };
    downloadFile(JSON.stringify(backup, null, 2), 'sop-backup-' + Date.now() + '.json', 'application/json');
  } catch (e) {
    alert('Error creating backup: ' + e.message);
  }
}

function importSOPs() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const backup = JSON.parse(event.target.result);
        if (!backup.data) throw new Error('Invalid backup file');
        
        let importedCount = 0;
        Object.keys(backup.data).forEach(id => {
          if (backup.data[id] && backup.data[id].id && backup.data[id].name && Array.isArray(backup.data[id].steps)) {
            allSOPs[id] = backup.data[id];
            importedCount++;
          }
        });
        
        alert(`Imported ${importedCount} SOPs successfully!`);
        saveToStorage();
        renderSOPList();
      } catch (e) {
        alert('Error importing: ' + e.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
}

// ============ SHARE ============
function openShareModal() {
  const shareData = btoa(JSON.stringify({ steps, name: allSOPs[currentSOPId]?.name || 'SOP' }));
  const shareLink = `${window.location.href.split('?')[0]}?sop=${shareData}`;
  document.getElementById('shareLink').textContent = shareLink;
  document.getElementById('shareModal').classList.add('active');
}

function closeShareModal() {
  document.getElementById('shareModal').classList.remove('active');
}

function copyToClipboard() {
  const link = document.getElementById('shareLink');
  const range = document.createRange();
  range.selectNodeContents(link);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
  document.execCommand('copy');
  alert('Link copied!');
}

// ============ TEMPLATES ============
function loadTemplate(name) {
  if (!confirm('Replace current SOP with this template?')) return;
  
  steps = JSON.parse(JSON.stringify(templates[name]));
  history = [JSON.stringify(steps)];
  redoStack = [];
  render();
  updateHistoryButtons();
  saveHistory();
  markUnsaved();
}

// ============ STORAGE ============
function saveToStorage() {
  try {
    localStorage.setItem('allSOPs', JSON.stringify(allSOPs));
    localStorage.setItem('trash', JSON.stringify(trash));
    localStorage.setItem('usageStats', JSON.stringify(usageStats));
  } catch (e) {
    console.error('Storage error:', e);
    alert('Storage full! Export your SOPs as backup.');
  }
}

function loadFromStorage() {
  try {
    const stored = localStorage.getItem('allSOPs');
    if (stored) allSOPs = JSON.parse(stored);
    
    const trashedStored = localStorage.getItem('trash');
    if (trashedStored) trash = JSON.parse(trashedStored);
    
    const usageStored = localStorage.getItem('usageStats');
    if (usageStored) usageStats = JSON.parse(usageStored);
  } catch (e) {
    console.error('Failed to load from storage', e);
    allSOPs = {};
    trash = {};
    usageStats = {};
  }
}

function loadFromUrl() {
  const params = new URLSearchParams(window.location.search);
  if (params.has('sop')) {
    try {
      const data = JSON.parse(atob(params.get('sop')));
      steps = data.steps || [];
      document.getElementById('sopTitle').textContent = data.name || 'Shared SOP';
      document.getElementById('sopNameInput').value = data.name || 'Shared SOP';
      document.getElementById('sopNameInput').disabled = true;
      history = [JSON.stringify(steps)];
      renderSteps();
      renderDiagram();
      
      document.querySelectorAll('.toolbar button').forEach(btn => btn.disabled = true);
    } catch (e) {
      console.error('Failed to load shared SOP', e);
      alert('Error loading shared SOP.');
    }
  }
}

// ============ UTILITIES ============
function escapeHtml(text) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

// ============ INIT ============
window.addEventListener('load', () => {
  loadFromStorage();
  const params = new URLSearchParams(window.location.search);
  
  if (params.has('sop')) {
    loadFromUrl();
  } else {
    renderSOPList();
    const firstSOP = Object.keys(allSOPs)[0];
    if (firstSOP) {
      loadSOP(firstSOP);
    } else {
      createNewSOP();
    }
  }
  
  // Periodic auto-save every 30 seconds
  setInterval(() => {
    if (currentSOPId && steps.length > 0) {
      allSOPs[currentSOPId].steps = steps;
      allSOPs[currentSOPId].tags = tags;
      allSOPs[currentSOPId].comments = comments;
      saveToStorage();
    }
  }, 30000);
}, false);
</script>

</body>
</html>
